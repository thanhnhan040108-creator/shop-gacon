<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>SHOP-GACON</h1>
      </div>
      <div class="right">
        <div class="pill">User: <b id="uName">-</b></div>
        <div class="pill">S·ªë d∆∞: <b id="uBal">0</b>ƒë</div>
        <button class="btn-secondary" id="btnLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>D·ªãch v·ª• (Blox Fruit)</h2>
        <div class="muted">Nh·∫≠p ghi ch√∫ cho ƒë∆°n (acc/y√™u c·∫ßu/gi·ªù l√†m...) r·ªìi b·∫•m Mua.</div>
        <div id="services"></div>
      </div>

      <div>
        <div class="card">
          <h2>N·∫°p ti·ªÅn (MB Bank)</h2>
          <div class="muted">Chuy·ªÉn kho·∫£n theo QR v√† nh·∫≠p ƒë√∫ng <b>n·ªôi dung</b> ƒë·ªÉ admin duy·ªát nhanh.</div>

          <div class="hr"></div>

          <div class="bank-box">
            <div>
              <div><b>Ng√¢n h√†ng:</b> MB Bank</div>
              <div><b>Ch·ªß TK:</b> VAN VIET THANH NHAN</div>
              <div><b>S·ªë TK:</b> 7475040109</div>
              <div class="muted">T·∫°o m√£ n·∫°p b√™n d∆∞·ªõi, copy ƒë√∫ng v√†o ‚ÄúN·ªôi dung chuy·ªÉn kho·∫£n‚Äù.</div>
            </div>
            <div class="bank-qr">
              <img src="/mb-qr.jpg" alt="QR MB Bank" />
            </div>
          </div>

          <div class="row">
            <input id="topupAmount" type="number" placeholder="S·ªë ti·ªÅn c·∫ßn n·∫°p (VD: 50000)" />
            <button id="btnCreateTopup">T·∫°o m√£ n·∫°p</button>
          </div>

          <div id="topupResult" class="note" style="display:none"></div>

          <div class="row">
            <button id="btnIHavePaid" class="btn-secondary" disabled>T√¥i ƒë√£ chuy·ªÉn kho·∫£n</button>
          </div>
        </div>

        <div class="card section-title">
          <h2>L·ªãch s·ª≠ n·∫°p</h2>
          <div id="topupHistory" class="list"></div>
        </div>

        <div class="card section-title">
          <h2>L·ªãch s·ª≠ mua</h2>
          <div id="orderHistory" class="list"></div>
        </div>

        <div id="msg" class="note" style="display:none"></div>
      </div>
    </div>
  </div>

<script>
const username = localStorage.getItem("username");
if(!username) location.href = "/";

uName.textContent = username;

btnLogout.onclick = () => {
  localStorage.removeItem("username");
  localStorage.removeItem("gmail");
  location.href = "/";
};

function money(n){ return Number(n).toLocaleString("vi-VN"); }
function showMsg(text){ msg.style.display = "block"; msg.innerText = text; }
function badge(status){ return `<span class="badge ${status}">${status}</span>`; }

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function refreshBalance(){
  const r = await fetch("/api/balance?username=" + encodeURIComponent(username));
  const d = await r.json();
  uBal.textContent = money(d.balance || 0);
}

async function loadServices(){
  const r = await fetch("/api/services");
  const d = await r.json();
  const list = d.services || [];

  const groups = {};
  for(const s of list){
    groups[s.category] = groups[s.category] || [];
    groups[s.category].push(s);
  }

  let html = "";
  Object.keys(groups).forEach(cat => {
    html += `
      <div class="card" style="margin-top:12px;background:rgba(12,23,45,.45)">
        <h2 style="margin:0 0 8px 0">${escapeHtml(cat)}</h2>
        <div class="list">
          ${groups[cat].map(s => `
            <div class="item">
              <div style="flex:1">
                <b>${escapeHtml(s.name)}</b>
                ${s.note ? `<div class="muted">${escapeHtml(s.note)}</div>` : ``}
                <div class="muted">Gi√°: <b>${s.price > 0 ? money(s.price) + "ƒë" : "IB b√°o gi√°"}</b></div>

                <div style="margin-top:10px">
                  <textarea class="order-note" rows="3"
                    placeholder="Ghi ch√∫ ƒë∆°n (acc, y√™u c·∫ßu, th·ªùi gian...)">${""}</textarea>
                </div>
              </div>
              <div>
                <button ${s.price>0 ? "" : "disabled"} data-id="${s.id}">Mua</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  });

  services.innerHTML = html;

  services.querySelectorAll("button[data-id]").forEach(btn => {
    btn.onclick = async () => {
      const serviceId = btn.getAttribute("data-id");
      const note = btn.closest(".item").querySelector(".order-note")?.value || "";

      const r2 = await fetch("/api/orders", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ username, serviceId, note })
      });
      const o = await r2.json();
      if(!o.ok) return showMsg(o.msg || "Mua th·∫•t b·∫°i");

      showMsg("Mua th√†nh c√¥ng! Admin s·∫Ω chuy·ªÉn tr·∫°ng th√°i khi ƒëang l√†m/ho√†n th√†nh.");
      await refreshBalance();
      await loadOrders();
    };
  });
}

async function loadTopups(){
  const r = await fetch("/api/topups?username=" + encodeURIComponent(username));
  const d = await r.json();
  const list = d.topups || [];
  if(!list.length){
    topupHistory.innerHTML = `<div class="muted">Ch∆∞a c√≥ giao d·ªãch n·∫°p.</div>`;
    return;
  }
  topupHistory.innerHTML = list.map(t => `
    <div class="item">
      <div>
        <b>${money(t.amount)}ƒë</b> ${badge(t.status)}
        <div class="muted">M√£ n·ªôi dung: <span class="code">${t.code}</span></div>
        <div class="muted">${new Date(t.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

async function loadOrders(){
  const r = await fetch("/api/orders?username=" + encodeURIComponent(username));
  const d = await r.json();
  const list = d.orders || [];
  if(!list.length){
    orderHistory.innerHTML = `<div class="muted">Ch∆∞a c√≥ l·ªãch s·ª≠ mua.</div>`;
    return;
  }
  orderHistory.innerHTML = list.map(o => `
    <div class="item">
      <div>
        <b>${escapeHtml(o.serviceName)}</b> ${badge(o.status)}
        <div class="muted">M·ª•c: ${escapeHtml(o.category || "")}</div>
        ${o.note ? `<div class="muted">üìù ${escapeHtml(o.note)}</div>` : ``}
        <div class="muted">${money(o.amount)}ƒë ‚Ä¢ ${new Date(o.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

// ===== TOPUP create =====
let lastTopupId = null;

function showTopupBox(html){
  topupResult.style.display = "block";
  topupResult.innerHTML = html;
}

btnCreateTopup.onclick = async () => {
  const amount = Number(topupAmount.value || 0);
  if(amount < 1000) return showMsg("Nh·∫≠p s·ªë ti·ªÅn >= 1.000ƒë");

  const r = await fetch("/api/topups", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username, amount })
  });
  const d = await r.json();
  if(!d.ok) return showMsg(d.msg || "L·ªói t·∫°o m√£ n·∫°p");

  lastTopupId = d.topup.id;
  btnIHavePaid.disabled = false;

  showTopupBox(
    `<div>M√£ n·∫°p c·ªßa b·∫°n: <span class="code">${d.topup.code}</span></div>
     <div>Chuy·ªÉn kho·∫£n v·ªõi <b>N·ªôi dung</b>: <span class="code">${d.topup.code}</span></div>
     <div class="muted">Admin s·∫Ω duy·ªát sau khi ki·ªÉm tra giao d·ªãch.</div>`
  );

  await loadTopups();
};

btnIHavePaid.onclick = async () => {
  if(!lastTopupId) return showMsg("B·∫°n ch∆∞a t·∫°o m√£ n·∫°p");
  showMsg("ƒê√£ ghi nh·∫≠n. Vui l√≤ng ch·ªù admin duy·ªát.");
};

(async function init(){
  await refreshBalance();
  await loadServices();
  await loadTopups();
  await loadOrders();
})();
</script>
</body>
</html>
