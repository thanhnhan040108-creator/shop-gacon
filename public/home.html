<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop Gà Con — Home</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>Shop Gà Con</h1>
        <div class="sub" id="hello">Xin chào</div>
      </div>
      <div class="row">
        <span class="badge"><span class="dot"></span> <span id="balanceText">Số dư: 0đ</span></span>
        <button class="btn danger" onclick="logout()">Đăng xuất</button>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="head"><h2>Dịch vụ VOCALA</h2></div>
        <div class="body">
          <div class="muted">Chọn dịch vụ → ghi chú (acc/yêu cầu) → tạo đơn. Sau đó bạn có thể <b>thanh toán bằng số dư</b> hoặc vào trang thanh toán chuyển khoản.</div>
          <div id="services"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="head"><h2>Nạp tiền</h2></div>
          <div class="body">
            <div class="sectionTitle">A) Chuyển khoản (MB Bank)</div>
            <div class="label">Số tiền (VND)</div>
            <input id="bankAmount" class="input" type="number" placeholder="vd: 50000" />
            <div class="label">Phương thức</div>
            <select id="bankMethod" class="input">
              <option>MB Bank</option>
            </select>
            <div class="hr"></div>
            <button class="btn primary" onclick="createBankTopup()">Tạo mã nạp (Bank)</button>
            <div id="bankResult" class="muted" style="margin-top:10px"></div>

            <div class="hr"></div>

            <div class="sectionTitle">B) Nạp thẻ cào (tạo yêu cầu)</div>
            <div class="muted">
              Nhà mạng: Viettel / Mobifone / Vinaphone / Garena / Zing<br/>
              Mệnh giá: 20k / 50k / 100k / 200k / 500k<br/>
              Phí: <b>dưới 50k = 20%</b>, còn lại <b>15%</b> (cộng tiền sau khi admin duyệt)
            </div>

            <div class="label">Nhà mạng</div>
            <select id="cardTelco" class="input">
              <option>Viettel</option>
              <option>Mobifone</option>
              <option>Vinaphone</option>
              <option>Garena</option>
              <option>Zing</option>
            </select>

            <div class="label">Mệnh giá</div>
            <select id="cardAmount" class="input">
              <option value="20000">20.000</option>
              <option value="50000">50.000</option>
              <option value="100000">100.000</option>
              <option value="200000">200.000</option>
              <option value="500000">500.000</option>
            </select>

            <div class="label">Serial</div>
            <input id="cardSerial" class="input" placeholder="Nhập serial" />

            <div class="label">Mã thẻ (PIN)</div>
            <input id="cardPin" class="input" placeholder="Nhập mã thẻ" />

            <div class="hr"></div>
            <button class="btn primary" onclick="createCardTopup()">Gửi nạp thẻ</button>
            <div id="cardResult" class="muted" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <h2>Lịch sử</h2>
            <button class="btn small" onclick="loadHistory()">Tải lại</button>
          </div>
          <div class="body">
            <div id="history" class="muted">Đang tải...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nút message -> FB link bạn đưa -->
  <a class="fab" href="https://www.facebook.com/share/1ajgzqUGdh/" target="_blank" aria-label="Message">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
      <path d="M12 3C7.03 3 3 6.61 3 11.06c0 2.54 1.3 4.8 3.33 6.29V21l3.54-1.95c.69.19 1.42.3 2.13.3 4.97 0 9-3.61 9-8.06S16.97 3 12 3Z" stroke="white" stroke-width="1.8" opacity=".95"/>
      <path d="M7.4 13.2 10.6 9.8 13 12.2 16.6 9.2" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>

  <div class="toast" id="toast"><b id="tTitle">Thông báo</b><div id="tMsg" class="muted"></div></div>

<script>
  const toast = (title, msg) => {
    document.getElementById('tTitle').textContent = title;
    document.getElementById('tMsg').textContent = msg || '';
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2600);
  };

  function fmtVND(n){
    try { return new Intl.NumberFormat('vi-VN').format(n) + 'đ'; } catch(e){ return n + 'đ'; }
  }

  function getToken(){
    return localStorage.getItem('userToken') || '';
  }

  function requireLogin(){
    const t = getToken();
    if(!t){
      location.href = '/index.html';
      return false;
    }
    return true;
  }

  function logout(){
    localStorage.removeItem('userToken');
    localStorage.removeItem('userInfo');
    location.href = '/index.html';
  }

  async function api(url, opts={}){
    opts.headers = Object.assign({}, opts.headers || {}, {
      'Content-Type':'application/json',
      'x-auth-token': getToken()
    });
    const r = await fetch(url, opts);
    const j = await r.json().catch(()=>({ok:false, message:'Lỗi đọc JSON'}));
    if(!r.ok && j && j.message) throw new Error(j.message);
    return j;
  }

  async function loadServices(){
    const r = await fetch('/api/services');
    const j = await r.json();
    const wrap = document.getElementById('services');
    wrap.innerHTML = '';
    if(!j.ok) return wrap.innerHTML = '<div class="muted">Không tải được dịch vụ</div>';

    j.services.forEach(group=>{
      const box = document.createElement('div');
      box.className = 'serviceGroup';
      box.innerHTML = `<h3>${group.group}</h3>`;
      group.items.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'serviceItem';
        row.innerHTML = `
          <div class="serviceInfo">
            <div class="name">${item.name}</div>
            <div class="note">${item.note ? item.note : ''}</div>
            <div class="label" style="margin-top:8px">Ghi chú đơn (acc/yêu cầu)</div>
            <textarea class="input" data-note="${item.key}" placeholder="VD: acc/mk, yêu cầu, thời gian rảnh..."></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="createOrder('${item.key}')">Tạo đơn</button>
              <button class="btn" onclick="goPaymentForService('${item.key}')">Thanh toán (Bank)</button>
            </div>
          </div>
          <div class="price">${fmtVND(item.price)}</div>
        `;
        box.appendChild(row);
      });
      wrap.appendChild(box);
    });
  }

  async function createOrder(serviceKey){
    if(!requireLogin()) return;
    const ta = document.querySelector(`textarea[data-note="${serviceKey}"]`);
    const note = ta ? ta.value.trim() : '';
    try{
      const j = await api('/api/orders/create', {
        method:'POST',
        body: JSON.stringify({ serviceKey, note })
      });
      toast('OK', 'Tạo đơn thành công');
      await loadHistory();
    }catch(e){
      toast('Lỗi', e.message);
    }
  }

  // Nếu bạn bấm "Thanh toán (Bank)" trước khi tạo đơn: tạo luôn đơn rồi chuyển payment
  async function goPaymentForService(serviceKey){
    if(!requireLogin()) return;
    const ta = document.querySelector(`textarea[data-note="${serviceKey}"]`);
    const note = ta ? ta.value.trim() : '';
    try{
      const j = await api('/api/orders/create', {
        method:'POST',
        body: JSON.stringify({ serviceKey, note })
      });
      location.href = `/payment.html?orderId=${encodeURIComponent(j.order.id)}`;
    }catch(e){
      toast('Lỗi', e.message);
    }
  }

  async function createBankTopup(){
    if(!requireLogin()) return;
    const amount = Number(document.getElementById('bankAmount').value);
    const method = document.getElementById('bankMethod').value;
    const out = document.getElementById('bankResult');
    out.textContent = '';
    if(!amount || amount <= 0) return toast('Lỗi', 'Nhập số tiền hợp lệ');

    try{
      const j = await api('/api/topup/bank/create', {
        method:'POST',
        body: JSON.stringify({ method, amount })
      });

      out.innerHTML = `
        <div class="kv"><b>Tạo mã nạp thành công</b><span class="tag warn">Chờ admin duyệt</span></div>
        <div class="hr"></div>
        <div class="muted">
          Nội dung chuyển khoản / thanh toán: <b>${j.topup.code}</b><br/>
          Số tiền: <b>${fmtVND(j.topup.amount)}</b><br/>
          <button class="btn small" onclick="location.href='/payment.html?topupId=${j.topup.id}'">Mở trang thanh toán</button>
        </div>
      `;
      await loadHistory();
    }catch(e){
      toast('Lỗi', e.message);
    }
  }

  async function createCardTopup(){
    if(!requireLogin()) return;
    const telco = document.getElementById('cardTelco').value;
    const amount = Number(document.getElementById('cardAmount').value);
    const serial = document.getElementById('cardSerial').value.trim();
    const pin = document.getElementById('cardPin').value.trim();
    const out = document.getElementById('cardResult');
    out.textContent = '';

    try{
      const j = await api('/api/topup/card/create', {
        method:'POST',
        body: JSON.stringify({ telco, amount, serial, pin })
      });
      out.innerHTML = `
        <div class="kv"><b>Đã gửi nạp thẻ</b><span class="tag warn">Chờ admin duyệt</span></div>
        <div class="muted" style="margin-top:8px">${j.topup.note}</div>
      `;
      document.getElementById('cardSerial').value = '';
      document.getElementById('cardPin').value = '';
      await loadHistory();
      toast('OK', 'Gửi nạp thẻ thành công');
    }catch(e){
      toast('Lỗi', e.message);
    }
  }

  async function payOrder(orderId){
    if(!requireLogin()) return;
    try{
      const j = await api('/api/orders/pay', {
        method:'POST',
        body: JSON.stringify({ orderId })
      });
      toast('OK', j.message || 'Thanh toán OK');
      document.getElementById('balanceText').textContent = 'Số dư: ' + fmtVND(j.balance);
      await loadHistory();
    }catch(e){
      toast('Lỗi', e.message);
    }
  }

  function tagForStatus(st){
    if(st === 'DONE') return '<span class="tag ok">DONE</span>';
    if(st === 'WORKING') return '<span class="tag warn">WORKING</span>';
    if(st === 'CANCELLED') return '<span class="tag bad">CANCELLED</span>';
    return '<span class="tag warn">PENDING</span>';
  }

  async function loadHistory(){
    if(!requireLogin()) return;
    const h = document.getElementById('history');
    h.textContent = 'Đang tải...';
    try{
      const j = await api('/api/history', { method:'GET' });
      document.getElementById('balanceText').textContent = 'Số dư: ' + fmtVND(j.user.balance);

      const orders = j.orders || [];
      const topups = j.topups || [];

      let html = '';
      html += `<div class="sectionTitle">Đơn hàng</div>`;
      if(!orders.length) html += `<div class="muted">Chưa có đơn.</div>`;
      else{
        html += `<table class="table"><thead><tr>
          <th>Thời gian</th><th>Dịch vụ</th><th>Giá</th><th>Trạng thái</th><th>Thanh toán</th>
        </tr></thead><tbody>`;
        orders.forEach(o=>{
          html += `<tr>
            <td>${new Date(o.createdAt).toLocaleString('vi-VN')}</td>
            <td><b>${o.serviceName}</b><br/><span class="muted">${o.note || ''}</span><br/><span class="muted">${o.adminNote || ''}</span></td>
            <td>${fmtVND(o.price)}</td>
            <td>${tagForStatus(o.status)}</td>
            <td>
              ${o.paid ? '<span class="tag ok">Đã trả</span>' : `
                <button class="btn small primary" onclick="payOrder('${o.id}')">Trả bằng số dư</button>
                <button class="btn small" onclick="location.href='/payment.html?orderId=${o.id}'">Bank</button>
              `}
            </td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }

      html += `<div class="hr"></div>`;
      html += `<div class="sectionTitle">Nạp tiền</div>`;
      if(!topups.length) html += `<div class="muted">Chưa có nạp.</div>`;
      else{
        html += `<table class="table"><thead><tr>
          <th>Thời gian</th><th>Loại</th><th>Số tiền</th><th>Trạng thái</th><th>Ghi chú</th>
        </tr></thead><tbody>`;
        topups.forEach(t=>{
          const type = (t.type === 'CARD') ? `CARD (${t.method})` : `BANK (${t.method})`;
          const st = t.status === 'APPROVED' ? '<span class="tag ok">APPROVED</span>' :
                     t.status === 'REJECTED' ? '<span class="tag bad">REJECTED</span>' :
                     '<span class="tag warn">WAITING</span>';
          html += `<tr>
            <td>${new Date(t.createdAt).toLocaleString('vi-VN')}</td>
            <td>${type}${t.code ? `<br/><span class="muted">${t.code}</span>` : ''}</td>
            <td>${fmtVND(t.amount)}</td>
            <td>${st}</td>
            <td><span class="muted">${t.note || ''}</span></td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }

      h.innerHTML = html;
    }catch(e){
      h.textContent = 'Lỗi tải lịch sử: ' + e.message;
    }
  }

  (async function init(){
    if(!requireLogin()) return;
    const u = JSON.parse(localStorage.getItem('userInfo') || '{}');
    document.getElementById('hello').textContent = `Xin chào ${u.username || ''} • ${u.email || ''}`;
    await loadServices();
    await loadHistory();
  })();
</script>
</body>
                                                        </html>
