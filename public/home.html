<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home - Shop G√† Con</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body class="page">
  <div class="container">
    <div class="topbar">
      <div>
        <b>Shop G√† Con</b>
        <div id="welcome" class="muted" style="font-size:12px">...</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="admin.html">Admin</a>
        <button class="btn" id="btnLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="col" style="flex:1.6">
        <div class="card">
          <h2>B·∫£ng d·ªãch v·ª•</h2>
          <div class="muted" style="font-size:12px">Nh·∫≠p ghi ch√∫ (acc/y√™u c·∫ßu/th·ªùi gian) ‚Üí b·∫•m Mua/T·∫°o ƒë∆°n. D·ªãch v·ª• gi√° 0 s·∫Ω l√† ‚ÄúIB b√°o gi√°‚Äù.</div>
          <div class="hr"></div>
          <div id="services">ƒêang t·∫£i...</div>
        </div>
      </div>

      <div class="col" style="flex:1">
        <div class="card">
          <h2>N·∫°p ti·ªÅn (QR)</h2>
          <div class="muted" style="font-size:12px">
            Qu√©t QR, chuy·ªÉn kho·∫£n xong g·ª≠i ‚ÄúY√™u c·∫ßu n·∫°p‚Äù ƒë·ªÉ admin duy·ªát c·ªông s·ªë d∆∞.
          </div>

          <div class="hr"></div>

          <img src="mb-pr.jpg" alt="MB QR" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10)" />

          <div class="field">
            <label>S·ªë ti·ªÅn mu·ªën n·∫°p (VND)</label>
            <input id="topAmount" type="number" placeholder="vd: 10000" />
          </div>
          <div class="field">
            <label>N·ªôi dung chuy·ªÉn kho·∫£n (ƒë·ªÉ admin ƒë·ªëi chi·∫øu)</label>
            <input id="topNote" placeholder="vd: NAP GACON user123 10k" />
          </div>
          <button class="btn primary" id="btnTopup">G·ª≠i y√™u c·∫ßu n·∫°p</button>
          <div id="topMsg" class="muted" style="margin-top:10px"></div>

          <div class="hr"></div>

          <h2>L·ªãch s·ª≠</h2>
          <button class="btn" id="btnReload">T·∫£i l·∫°i ƒë∆°n + n·∫°p</button>
          <div id="history" style="margin-top:10px">...</div>
        </div>
      </div>
    </div>
  </div>

  <a class="msg-float" target="_blank" href="https://www.facebook.com/share/1ajgzqUGdh/" title="Li√™n h·ªá Facebook">üí¨</a>

  <script>
    function token(){ return localStorage.getItem("token") || ""; }

    async function api(path, method="GET", body=null){
      const headers = {};
      if (token()) headers["Authorization"] = "Bearer " + token();
      if (body) headers["Content-Type"] = "application/json";
      const res = await fetch(path, { method, headers, body: body?JSON.stringify(body):null });
      return res.json();
    }
    function money(v){ return (Number(v||0)).toLocaleString("vi-VN") + "ƒë"; }
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    // Auth check
    (async () => {
      if(!token()) return location.href="index.html";
      const me = await api("/api/me");
      if(!me.ok) return location.href="index.html";
      if(me.user.role !== "user") return location.href="admin-dashboard.html";

      document.getElementById("welcome").textContent =
        `Xin ch√†o ${me.user.username} ‚Ä¢ S·ªë d∆∞: ${money(me.user.balance)}`;

      await loadServices();
      await loadHistory();
    })();

    document.getElementById("btnLogout").onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("me");
      location.href = "index.html";
    };

    async function loadServices(){
      const box = document.getElementById("services");
      box.innerHTML = "ƒêang t·∫£i...";
      const data = await api("/api/services");
      if(!data.ok){ box.innerHTML = "L·ªói t·∫£i d·ªãch v·ª•"; return; }

      const list = data.services || [];
      if(!list.length){
        box.innerHTML = "<div class='muted'>Ch∆∞a c√≥ d·ªãch v·ª•. (B·∫°n c·∫ßn d√°n services v√†o Data.json)</div>";
        return;
      }

      // Group by category
      const groups = {};
      for(const s of list){
        const key = s.category || "Kh√°c";
        groups[key] = groups[key] || [];
        groups[key].push(s);
      }

      let html = "";
      for(const cat of Object.keys(groups)){
        html += `
          <div class="card" style="margin-bottom:12px;background:rgba(0,0,0,.15)">
            <b>${esc(cat)}</b>
            <div class="hr"></div>
        `;

        for(const s of groups[cat]){
          const disabled = Number(s.price) <= 0;
          html += `
            <div style="border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;margin-bottom:10px">
              <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between">
                <div style="flex:1">
                  <div style="font-weight:700">${esc(s.title)}</div>
                  ${s.desc ? `<div class="muted" style="font-size:12px;margin-top:4px">${esc(s.desc)}</div>` : ``}
                  <div class="muted" style="font-size:12px;margin-top:6px">
                    Gi√°: <b>${disabled ? "IB b√°o gi√°" : money(s.price)}</b>
                  </div>

                  <div class="field" style="margin:10px 0 0">
                    <label>Ghi ch√∫ ƒë∆°n</label>
                    <textarea id="note_${esc(s.id)}" placeholder="VD: acc/m·∫≠t kh·∫©u, y√™u c·∫ßu, th·ªùi gian r·∫£nh..."></textarea>
                  </div>
                </div>

                <div style="min-width:140px;display:flex;flex-direction:column;gap:8px">
                  <button class="btn primary" ${disabled ? "disabled" : ""} onclick="createOrder('${esc(s.id)}')">
                    ${disabled ? "IB" : "T·∫°o ƒë∆°n"}
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        html += `</div>`;
      }

      box.innerHTML = html;
    }

    window.createOrder = async (serviceId) => {
      const noteEl = document.getElementById("note_" + serviceId);
      const note = noteEl ? noteEl.value.trim() : "";

      const data = await api("/api/orders", "POST", { serviceId, note });
      if(!data.ok){
        alert("L·ªói t·∫°o ƒë∆°n: " + data.error);
        return;
      }
      alert("T·∫°o ƒë∆°n th√†nh c√¥ng! Tr·∫°ng th√°i: " + data.order.status);
      if(noteEl) noteEl.value = "";
      await loadHistory();
    };

    document.getElementById("btnTopup").onclick = async () => {
      const amount = Number(document.getElementById("topAmount").value || 0);
      const transferNote = document.getElementById("topNote").value.trim();
      const msg = document.getElementById("topMsg");
      msg.textContent = "ƒêang g·ª≠i...";

      const data = await api("/api/topups", "POST", { amount, method: "MB/Bank", transferNote });
      if(!data.ok){
        msg.textContent = "L·ªói: " + data.error;
        return;
      }
      msg.textContent = "ƒê√£ g·ª≠i y√™u c·∫ßu n·∫°p. Ch·ªù admin duy·ªát.";
      await loadHistory();
    };

    document.getElementById("btnReload").onclick = () => loadHistory();

    async function loadHistory(){
      const box = document.getElementById("history");
      box.innerHTML = "ƒêang t·∫£i...";

      const [orders, topups, me] = await Promise.all([
        api("/api/orders"),
        api("/api/topups"),
        api("/api/me")
      ]);

      if(me.ok){
        document.getElementById("welcome").textContent =
          `Xin ch√†o ${me.user.username} ‚Ä¢ S·ªë d∆∞: ${money(me.user.balance)}`;
      }

      let html = "";

      html += `<b>ƒê∆°n h√†ng</b><div class="muted" style="font-size:12px;margin:6px 0 10px">C√≥ tr·∫°ng th√°i + ghi ch√∫ admin.</div>`;
      if(orders.ok && orders.orders.length){
        html += `<table class="table">
          <thead><tr><th>M√£</th><th>D·ªãch v·ª•</th><th>Gi√°</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th></tr></thead><tbody>`;
        for(const o of orders.orders){
          html += `<tr>
            <td>${esc(o.id)}</td>
            <td><b>${esc(o.serviceTitle)}</b><div class="muted" style="font-size:12px">${esc(o.note||"")}</div></td>
            <td>${money(o.price)}</td>
            <td><span class="badge">${esc(o.status)}</span></td>
            <td class="muted" style="font-size:12px">${esc(o.adminNote||"")}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
      } else html += `<div class="muted">Ch∆∞a c√≥ ƒë∆°n.</div>`;

      html += `<div class="hr"></div>`;
      html += `<b>Y√™u c·∫ßu n·∫°p</b><div class="muted" style="font-size:12px;margin:6px 0 10px">Admin duy·ªát s·∫Ω c·ªông ti·ªÅn.</div>`;
      if(topups.ok && topups.topups.length){
        html += `<table class="table">
          <thead><tr><th>M√£</th><th>S·ªë ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>N·ªôi dung CK</th><th>Admin</th></tr></thead><tbody>`;
        for(const t of topups.topups){
          html += `<tr>
            <td>${esc(t.id)}</td>
            <td>${money(t.amount)}</td>
            <td><span class="badge">${esc(t.status)}</span></td>
            <td class="muted" style="font-size:12px">${esc(t.transferNote||"")}</td>
            <td class="muted" style="font-size:12px">${esc(t.adminNote||"")}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
      } else html += `<div class="muted">Ch∆∞a c√≥ y√™u c·∫ßu n·∫°p.</div>`;

      box.innerHTML = html;
    }
  </script>
</body>
  </html>
