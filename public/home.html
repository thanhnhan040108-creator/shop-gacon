<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop G√† Con - Home</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <div class="topbar">
    <div>
      <div class="title">Shop G√† Con</div>
      <div class="muted" id="hello"></div>
    </div>
    <div class="top-actions">
      <a class="btn ghost" href="admin.html">Admin</a>
      <button class="btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">

      <div class="card">
        <h3>D·ªãch v·ª•</h3>
        <div class="muted">C√≥ 2 c√°ch: (1) chuy·ªÉn kho·∫£n theo m√£ DON_‚Ä¶ ho·∫∑c (2) mua b·∫±ng s·ªë d∆∞</div>
        <div id="services"></div>
      </div>

      <div class="card">
        <h3>N·∫°p ti·ªÅn</h3>
        <div class="muted">N·∫°p MB ho·∫∑c n·∫°p th·∫ª c√†o</div>

        <div class="subcard">
          <h4>N·∫°p MB Bank</h4>

          <label>Ph∆∞∆°ng th·ª©c</label>
          <select id="method">
            <option>MB Bank</option>
          </select>

          <label>S·ªë ti·ªÅn (VND)</label>
          <input id="amount" inputmode="numeric" placeholder="vd: 50000" />
          <button class="btn" onclick="createTopup()">T·∫°o m√£ n·∫°p</button>
          <div class="hint">T·∫°o m√£ xong s·∫Ω chuy·ªÉn sang trang thanh to√°n.</div>
        </div>

        <div class="subcard">
          <h4>N·∫°p th·∫ª c√†o</h4>
          <div class="muted">Ph√≠: 20k/50k thu 15%, t·ª´ 100k tr·ªü l√™n thu 20%.</div>

          <label>Lo·∫°i th·∫ª</label>
          <select id="cardProvider">
            <option>Viettel</option>
            <option>Vinaphone</option>
            <option>Mobifone</option>
            <option>Garena</option>
            <option>Zing</option>
          </select>

          <label>M·ªánh gi√° (VND)</label>
          <select id="cardAmount">
            <option value="20000">20.000</option>
            <option value="50000">50.000</option>
            <option value="100000">100.000</option>
            <option value="200000">200.000</option>
            <option value="500000">500.000</option>
          </select>

          <label>Serial</label>
          <input id="cardSerial" placeholder="Nh·∫≠p s·ªë serial" />

          <label>M√£ th·∫ª</label>
          <input id="cardPin" placeholder="Nh·∫≠p m√£ th·∫ª" />

          <button class="btn" onclick="createCardTopup()">G·ª≠i th·∫ª</button>
          <div class="msg" id="cardMsg"></div>
        </div>

      </div>

      <div class="card">
        <div class="row-between">
          <div>
            <h3>L·ªãch s·ª≠</h3>
            <div class="muted">ƒê∆°n h√†ng + n·∫°p ti·ªÅn</div>
          </div>
          <button class="btn ghost" onclick="reloadAll()">T·∫£i l·∫°i</button>
        </div>

        <div class="subcard">
          <h4>ƒê∆°n h√†ng</h4>
          <div id="orders" class="list"></div>
        </div>

        <div class="subcard">
          <h4>N·∫°p MB</h4>
          <div id="topups" class="list"></div>
        </div>

        <div class="subcard">
          <h4>N·∫°p th·∫ª c√†o</h4>
          <div id="cardTopups" class="list"></div>
        </div>
      </div>

    </div>
  </div>

  <a class="float-msg" href="https://www.facebook.com/share/1ajgzqUGdh/" target="_blank" rel="noopener">üí¨</a>

<script>
  const u = JSON.parse(localStorage.getItem("user") || "null");
  if (!u) location.href = "index.html";

  function logout() {
    localStorage.clear();
    location.href = "index.html";
  }

  function formatVND(n) {
    n = Number(n || 0);
    return n.toLocaleString("vi-VN") + "ƒë";
  }

  async function refreshMe() {
    const r = await fetch("/api/me/" + encodeURIComponent(u.username));
    const d = await r.json();
    if (r.ok) {
      localStorage.setItem("user", JSON.stringify(d.user));
      hello.innerHTML = `Xin ch√†o <b>${d.user.username}</b> ‚Ä¢ S·ªë d∆∞: <b>${formatVND(d.user.balance)}</b>`;
    } else {
      hello.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin user";
    }
  }

  const SERVICES = [
    { title: "B√†ng Gi√° C√†y Thu√™ Blox Fruit", items: [
      { name:"Lv 1-700", price:10000 },
      { name:"Lv 700-1500", price:10000 },
      { name:"Lv 1500-max", price:20000 },
      { name:"Lv 1-max (c·∫£ l·∫•y godhuman)", price:50000 },
      { name:"9m beli", price:10000 },
      { name:"20k frag", price:10000 },
      { name:"1-600 mas (mele + ki·∫øm + tr√°i c√≥ m1)", price:10000 },
      { name:"1-600 mas (s√∫ng + tr√°i ko c√≥ m1)", price:20000 }
    ]},
    { title: "L·∫•y Melle / Items", items: [
      { name:"L·∫•y Death step/Sharkman karate/Electric claw/Dragon talon (10k/1 v√µ)", price:10000 },
      { name:"L·∫•y Godhuman + c√†y full skill (ƒê·ªß nguy√™n li·ªáu)", price:40000 },
      { name:"L·∫•y Godhuman (Ch∆∞a ƒë·ªß nguy√™n li·ªáu)", price:20000 },
      { name:"L·∫•y Sanguine art (ƒë√£ k√©o tim v·ªÅ tiki)", price:10000 },
      { name:"L·∫•y Curse dual katana", price:20000 },
      { name:"L·∫•y Shisui/Saddi/Wanno (7k/1 c√¢y, c·∫£ c√†y mas)", price:7000 },
      { name:"L·∫•y True Triple Katana (ƒë√£ c√≥ 3 ki·∫øm, ch·ªâ c√†y mas)", price:5000 },
      { name:"L·∫•y Fox lamp", price:40000 },
      { name:"L·∫•y Tushita", price:10000 },
      { name:"L·∫•y Yama", price:10000 },
      { name:"L·∫•y Shark Anchor", price:20000 },
      { name:"L·∫•y Soul guitar", price:10000 },
      { name:"L·∫•y Dark Fragment", price:7000 },
      { name:"N√¢ng sao ki·∫øm/s√∫ng (2k/1)", price:2000 },
      { name:"L·∫•y Haki legendary (20k/3 m√†u)", price:20000 }
    ]},
    { title: "Up t·ªôc v4", items: [
      { name:"L·∫•y t·ªôc Cyborg", price:20000 },
      { name:"L·∫•y t·ªôc Ghoul", price:10000 },
      { name:"Up t·ªôc v1-v3", price:10000 },
      { name:"G·∫°t c·∫ßn (C√≥ m·∫£nh g∆∞∆°ng, ƒë√°nh rip)", price:5000 },
      { name:"G·∫°t c·∫ßn (Ch∆∞a ƒë√°nh rip, dough king)", price:20000 },
      { name:"Up v4 1 gear", price:7000 },
      { name:"Up v4 full gear (bao frag, c·∫£ gear ƒë·ªïi)", price:40000 }
    ]},
    { title: "Leviathan", items: [
      { name:"Ph√° IDK", price:10000 },
      { name:"K√©o tim v·ªÅ Tiki", price:30000 },
      { name:"K√©o tim v·ªÅ Hydra", price:40000 }
    ]},
    { title: "Draco Update", items: [
      { name:"L·∫•y full ƒëai", price:20000 },
      { name:"L·∫•y t·ªôc Draco v1", price:7000 },
      { name:"Up Draco v1-v3 (y√™u c·∫ßu > 3.5m beli)", price:10000 },
      { name:"L·∫•y Dragon Heart", price:7000 },
      { name:"L·∫•y Dragon Storm", price:15000 },
      { name:"L·∫•y 1 tr·ª©ng", price:7000 },
      { name:"Up gear Draco (7k/1 gear ƒë√£ train)", price:7000 },
      { name:"Up gear Draco full gear (35k/full gear bao f)", price:35000 },
      { name:"Full combo A-Z", price:150000 }
    ]},
    { title: "Bounty Hunt", items: [
      { name:"1m Bounty h·∫£i t·∫∑c", price:10000 },
      { name:"1m Bounty h·∫£i qu√¢n", price:15000 }
    ]}
  ];

  function esc(s){ return String(s).replace(/'/g,"\\'"); }

  function renderServices() {
    services.innerHTML = SERVICES.map((cat, ci) => {
      const itemsHtml = cat.items.map((it, i) => {
        const id = `note_${ci}_${i}`;
        return `
          <div class="service-item">
            <div class="service-left">
              <div class="service-name">${it.name}</div>
              <div class="service-price">${formatVND(it.price)}</div>
            </div>
            <div class="service-right">
              <input id="${id}" class="note" placeholder="Ghi ch√∫: acc/mk, y√™u c·∫ßu, th·ªùi gian r·∫£nh..." />
              <button class="btn" onclick="createOrder('${esc(it.name)}', ${it.price}, document.getElementById('${id}').value)">
                T·∫°o ƒë∆°n (chuy·ªÉn kho·∫£n)
              </button>
              <button class="btn ghost" onclick="createOrderAndPayBalance('${esc(it.name)}', ${it.price}, document.getElementById('${id}').value)">
                Mua b·∫±ng s·ªë d∆∞
              </button>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="category"><div class="category-title">${cat.title}</div>${itemsHtml}</div>`;
    }).join("");
  }

  // ===== ƒê∆†N CHUY·ªÇN KHO·∫¢N =====
  async function createOrder(service, price, note) {
    const r = await fetch("/api/order", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        username: u.username,
        service,
        price,
        note: (note||"").trim()
      })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o ƒë∆°n");

    localStorage.setItem("pay_order", JSON.stringify(d));
    location.href = "payment.html?type=order";
  }

  // ===== MUA B·∫∞NG S·ªê D∆Ø =====
  async function payOrderByBalance(orderId){
    const r = await fetch("/api/order/pay-balance",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: u.username, orderId })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.msg || "Thanh to√°n th·∫•t b·∫°i");
    return d;
  }

  async function createOrderAndPayBalance(service, price, note){
    // t·∫°o ƒë∆°n tr∆∞·ªõc
    const r = await fetch("/api/order", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        username: u.username,
        service,
        price,
        note: (note||"").trim()
      })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o ƒë∆°n");

    // thanh to√°n b·∫±ng s·ªë d∆∞
    try{
      await payOrderByBalance(d.id);
      alert("Mua b·∫±ng s·ªë d∆∞ th√†nh c√¥ng!");
      await reloadAll();
    }catch(e){
      alert(e.message);
      // n·∫øu s·ªë d∆∞ kh√¥ng ƒë·ªß, v·∫´n c√≤n ƒë∆°n ch∆∞a thanh to√°n trong l·ªãch s·ª≠
      await reloadAll();
    }
  }

  // ===== N·∫†P MB =====
  async function createTopup() {
    const amt = Number(amount.value || 0);
    if (amt <= 0) return alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");

    const r = await fetch("/api/topup", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: u.username, amount: amt, method: method.value })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o m√£ n·∫°p");

    localStorage.setItem("pay_topup", JSON.stringify(d.topup));
    location.href = "payment.html?type=topup";
  }

  // ===== N·∫†P TH·∫∫ C√ÄO =====
  async function createCardTopup(){
    cardMsg.textContent = "";
    try{
      const body = {
        username: u.username,
        provider: cardProvider.value,
        amount: Number(cardAmount.value),
        serial: cardSerial.value,
        pin: cardPin.value
      };

      const r = await fetch("/api/cardtopup",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      const d = await r.json();
      if(!r.ok) throw new Error(d.msg || "L·ªói n·∫°p th·∫ª");

      cardMsg.textContent = `ƒê√£ g·ª≠i th·∫ª. M√£: ${d.card.code} ‚Ä¢ Nh·∫≠n: ${formatVND(d.card.netAmount)}`;
      cardSerial.value = "";
      cardPin.value = "";

      await loadCardTopups();
      await refreshMe();
    }catch(e){
      cardMsg.textContent = e.message;
    }
  }

  // ===== L·ªäCH S·ª¨ =====
  async function loadOrders() {
    const r = await fetch("/api/orders/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { orders.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n</div>`; return; }
    if(!d.length) { orders.innerHTML = `<div class="muted">Ch∆∞a c√≥ ƒë∆°n</div>`; return; }

    orders.innerHTML = d.map(o => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${o.service}</div>
          <div class="row-sub">
            ${formatVND(o.price)} ‚Ä¢ ${o.time}<br>
            <b>Thanh to√°n:</b> ${o.paidStatus || "Ch∆∞a thanh to√°n"} ‚Ä¢ <b>M√£:</b> ${o.payCode || ""}<br>
            <b>Tr·∫°ng th√°i:</b> ${o.status}${o.adminNote ? ` ‚Ä¢ <b>Admin:</b> ${o.adminNote}` : ""}<br>
            <b>Ghi ch√∫:</b> ${o.note || "(tr·ªëng)"}<br>
            ${o.payMethod ? `<b>H√¨nh th·ª©c:</b> ${o.payMethod}<br>` : ``}
          </div>

          ${(o.paidStatus || "Ch∆∞a thanh to√°n") !== "ƒê√£ thanh to√°n"
            ? `<div style="margin-top:10px" class="inline">
                 <button class="btn" onclick="payFromHistory(${o.id})">Thanh to√°n b·∫±ng s·ªë d∆∞</button>
               </div>`
            : ""
          }
        </div>
      </div>
    `).join("");
  }

  async function payFromHistory(orderId){
    try{
      await payOrderByBalance(orderId);
      alert("Thanh to√°n b·∫±ng s·ªë d∆∞ th√†nh c√¥ng!");
      await reloadAll();
    }catch(e){
      alert(e.message);
    }
  }

  async function loadTopups() {
    const r = await fetch("/api/topups/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { topups.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c n·∫°p</div>`; return; }
    if(!d.length) { topups.innerHTML = `<div class="muted">Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p</div>`; return; }

    topups.innerHTML = d.map(t => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${t.method} ‚Ä¢ ${formatVND(t.amount)}</div>
          <div class="row-sub">
            <b>M√£:</b> ${t.code} ‚Ä¢ ${t.time}<br>
            <b>Tr·∫°ng th√°i:</b> ${t.status}
          </div>
        </div>
      </div>
    `).join("");
  }

  async function loadCardTopups(){
    const r = await fetch("/api/cardtopups/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { cardTopups.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ th·∫ª</div>`; return; }
    if(!d.length) { cardTopups.innerHTML = `<div class="muted">Ch∆∞a c√≥ n·∫°p th·∫ª</div>`; return; }

    cardTopups.innerHTML = d.map(c => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${c.provider} ‚Ä¢ ${formatVND(c.amount)}</div>
          <div class="row-sub">
            <b>M√£:</b> ${c.code} ‚Ä¢ ${c.time}<br>
            <b>Ph√≠:</b> ${c.feePercent}% ‚Üí <b>Nh·∫≠n:</b> ${formatVND(c.netAmount)}<br>
            <b>Tr·∫°ng th√°i:</b> ${c.status}${c.adminNote ? ` ‚Ä¢ <b>Admin:</b> ${c.adminNote}` : ""}
          </div>
        </div>
      </div>
    `).join("");
  }

  async function reloadAll() {
    await refreshMe();
    await loadOrders();
    await loadTopups();
    await loadCardTopups();
  }

  renderServices();
  reloadAll();
</script>
</body>
</html>
