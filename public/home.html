      <!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop G√† Con - Home</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <div class="topbar">
    <div>
      <div class="title">Shop G√† Con</div>
      <div class="muted" id="hello"></div>
    </div>
    <div class="top-actions">
      <a class="btn ghost" href="admin.html">Admin</a>
      <button class="btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">

      <!-- SERVICES -->
      <div class="card">
        <h3>D·ªãch v·ª• C√†y VOCALA</h3>
        <div class="muted">
          Ch·ªçn d·ªãch v·ª• ‚Üí ghi ch√∫ (acc/mk, y√™u c·∫ßu, th·ªùi gian r·∫£nh...) ‚Üí t·∫°o ƒë∆°n.
          <br>
          C√≥ 2 c√°ch: <b>T·∫°o ƒë∆°n (chuy·ªÉn kho·∫£n)</b> ho·∫∑c <b>Mua b·∫±ng s·ªë d∆∞</b>.
        </div>
        <div id="services"></div>
      </div>

      <!-- TOPUP -->
      <div class="card">
        <h3>N·∫°p ti·ªÅn</h3>
        <div class="muted">N·∫°p MB ho·∫∑c n·∫°p th·∫ª c√†o (admin duy·ªát ‚Üí s·ªë d∆∞ tƒÉng)</div>

        <div class="subcard">
          <h4>N·∫°p MB Bank</h4>

          <label>Ph∆∞∆°ng th·ª©c</label>
          <select id="method">
            <option>MB Bank</option>
          </select>

          <label>S·ªë ti·ªÅn (VND)</label>
          <input id="amount" inputmode="numeric" placeholder="vd: 50000" />

          <button class="btn" onclick="createTopup()">T·∫°o m√£ n·∫°p</button>
          <div class="hint">T·∫°o m√£ xong s·∫Ω chuy·ªÉn sang trang thanh to√°n.</div>
        </div>

        <div class="subcard">
          <h4>N·∫°p th·∫ª c√†o</h4>
          <div class="muted">
            Ph√≠: <b>15%</b> cho d∆∞·ªõi 100k ‚Ä¢ <b>20%</b> cho t·ª´ 100k tr·ªü l√™n
          </div>

          <label>Lo·∫°i th·∫ª</label>
          <select id="cardProvider">
            <option>Viettel</option>
            <option>Vinaphone</option>
            <option>Mobifone</option>
            <option>Garena</option>
            <option>Zing</option>
          </select>

          <label>M·ªánh gi√° (VND)</label>
          <select id="cardAmount">
            <option value="20000">20.000</option>
            <option value="50000">50.000</option>
            <option value="100000">100.000</option>
            <option value="200000">200.000</option>
            <option value="500000">500.000</option>
          </select>

          <label>Serial</label>
          <input id="cardSerial" placeholder="Nh·∫≠p s·ªë serial" />

          <label>M√£ th·∫ª</label>
          <input id="cardPin" placeholder="Nh·∫≠p m√£ th·∫ª" />

          <button class="btn" onclick="createCardTopup()">G·ª≠i th·∫ª</button>
          <div class="msg" id="cardMsg"></div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="card">
        <div class="row-between">
          <div>
            <h3>L·ªãch s·ª≠</h3>
            <div class="muted">ƒê∆°n h√†ng + n·∫°p ti·ªÅn</div>
          </div>
          <button class="btn ghost" onclick="reloadAll()">T·∫£i l·∫°i</button>
        </div>

        <div class="subcard">
          <h4>ƒê∆°n h√†ng</h4>
          <div id="orders" class="list"></div>
        </div>

        <div class="subcard">
          <h4>N·∫°p MB</h4>
          <div id="topups" class="list"></div>
        </div>

        <div class="subcard">
          <h4>N·∫°p th·∫ª c√†o</h4>
          <div id="cardTopups" class="list"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Floating message button -->
  <a class="float-msg"
     href="https://www.facebook.com/share/1ajgzqUGdh/"
     target="_blank"
     rel="noopener"
     title="Nh·∫Øn tin h·ªó tr·ª£">
    üí¨
  </a>

<script>
  // ===== AUTH CHECK =====
  const u = JSON.parse(localStorage.getItem("user") || "null");
  if (!u) location.href = "index.html";

  function logout() {
    localStorage.clear();
    location.href = "index.html";
  }

  // ===== UTILS =====
  function formatVND(n) {
    n = Number(n || 0);
    return n.toLocaleString("vi-VN") + "ƒë";
  }
  function esc(s){ return String(s).replace(/'/g,"\\'"); }

  // ===== SERVICES (VOCALA) =====
  const SERVICES = [
    {
      title: "Combo Draco / Draco",
      items: [
        { name: "Combo Draco", price: 100000 },
        { name: "ƒêai", price: 10000 },
        { name: "S√∫ng", price: 12000 },
        { name: "Ki·∫øm", price: 10000 },
        { name: "Tr·ª©ng r·ªìng", price: 5000 },
        { name: "ƒê·ªôc r·ª´ng", price: 5000 }
      ]
    },
    {
      title: "ITEM",
      items: [
        { name: "Yama", price: 5000 },
        { name: "Tushita", price: 5000 },
        { name: "Gh√©p", price: 5000 },
        { name: "A-Z CDK  (bao all)", price: 15000 },
        { name: "A-Z TT  (bao all)", price: 20000 },
        { name: "Shark Anchor", price: 10000 },
        { name: "Soul Guitar", price: 10000 },
        { name: "Yoru V3  (Y√™u c·∫ßu full 4 t·ªôc v3)", price: 20000 },
        { name: "Foxlamp", price: 15000 }
      ]
    },
    {
      title: "LEVI",
      items: [
        { name: "K√©o tim v·ªÅ Hydra", price: 20000 },
        { name: "K√©o tim v·ªÅ Tiki", price: 20000 },
        { name: "Mele m√°u", price: 30000 }
      ]
    },
    {
      title: "Ken & Mas",
      items: [
        { name: "Haki quan s√°t V2", price: 20000 },
        { name: "1 - 600 mas", price: 5000 }
      ]
    },
    {
      title: "RAID / MELEE",
      items: [
        { name: "1 - 700", price: 3000 },
        { name: "700 - 1500", price: 8000 },
        { name: "1500 - max", price: 15000 },
        { name: "1 - max", price: 20000 },
        { name: "Gear", price: 5000 },
        { name: "FG", price: 20000 },
        { name: "V1 - V3", price: 5000 }
      ]
    },
    {
      title: "BELI / FRAG",
      items: [
        { name: "2m beli", price: 1000 },
        { name: "2k frag", price: 1000 }
      ]
    }
  ];

  function renderServices() {
    services.innerHTML = SERVICES.map((cat, ci) => {
      const itemsHtml = cat.items.map((it, i) => {
        const id = `note_${ci}_${i}`;
        return `
          <div class="service-item">
            <div class="service-left">
              <div class="service-name">${it.name}</div>
              <div class="service-price">${formatVND(it.price)}</div>
            </div>
            <div class="service-right">
              <input id="${id}" class="note"
                placeholder="Ghi ch√∫: acc/mk, y√™u c·∫ßu, th·ªùi gian r·∫£nh..." />
              <button class="btn"
                onclick="createOrder('${esc(it.name)}', ${it.price}, document.getElementById('${id}').value)">
                T·∫°o ƒë∆°n (chuy·ªÉn kho·∫£n)
              </button>
              <button class="btn ghost"
                onclick="createOrderAndPayBalance('${esc(it.name)}', ${it.price}, document.getElementById('${id}').value)">
                Mua b·∫±ng s·ªë d∆∞
              </button>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="category">
          <div class="category-title">${cat.title}</div>
          ${itemsHtml}
        </div>
      `;
    }).join("");
  }

  // ===== ME =====
  async function refreshMe() {
    const r = await fetch("/api/me/" + encodeURIComponent(u.username));
    const d = await r.json();
    if (r.ok) {
      localStorage.setItem("user", JSON.stringify(d.user));
      hello.innerHTML = `Xin ch√†o <b>${d.user.username}</b> ‚Ä¢ S·ªë d∆∞: <b>${formatVND(d.user.balance)}</b>`;
    } else {
      hello.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin user";
    }
  }

  // ===== ORDERS =====
  async function createOrder(service, price, note) {
    const r = await fetch("/api/order", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        username: u.username,
        service,
        price,
        note: (note||"").trim()
      })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o ƒë∆°n");

    // chuy·ªÉn qua payment.html (n·∫øu b·∫°n c√≥ file n√†y)
    localStorage.setItem("pay_order", JSON.stringify(d));
    location.href = "payment.html?type=order";
  }

  async function payOrderByBalance(orderId){
    const r = await fetch("/api/order/pay-balance",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: u.username, orderId })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.msg || "Thanh to√°n th·∫•t b·∫°i");
    return d;
  }

  async function createOrderAndPayBalance(service, price, note){
    // t·∫°o ƒë∆°n tr∆∞·ªõc
    const r = await fetch("/api/order", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        username: u.username,
        service,
        price,
        note: (note||"").trim()
      })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o ƒë∆°n");

    // thanh to√°n b·∫±ng s·ªë d∆∞
    try{
      await payOrderByBalance(d.id);
      alert("Mua b·∫±ng s·ªë d∆∞ th√†nh c√¥ng!");
      await reloadAll();
    }catch(e){
      alert(e.message);
      // n·∫øu s·ªë d∆∞ kh√¥ng ƒë·ªß: ƒë∆°n v·∫´n n·∫±m trong l·ªãch s·ª≠, user c√≥ th·ªÉ thanh to√°n sau
      await reloadAll();
    }
  }

  async function loadOrders() {
    const r = await fetch("/api/orders/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { orders.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n</div>`; return; }
    if(!d.length) { orders.innerHTML = `<div class="muted">Ch∆∞a c√≥ ƒë∆°n</div>`; return; }

    orders.innerHTML = d.map(o => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${o.service}</div>
          <div class="row-sub">
            ${formatVND(o.price)} ‚Ä¢ ${o.time}<br>
            <b>Thanh to√°n:</b> ${o.paidStatus || "Ch∆∞a thanh to√°n"} ‚Ä¢ <b>M√£:</b> ${o.payCode || ""}<br>
            <b>Tr·∫°ng th√°i:</b> ${o.status}${o.adminNote ? ` ‚Ä¢ <b>Admin:</b> ${o.adminNote}` : ""}<br>
            <b>Ghi ch√∫:</b> ${o.note || "(tr·ªëng)"}<br>
            ${o.payMethod ? `<b>H√¨nh th·ª©c:</b> ${o.payMethod}<br>` : ``}
          </div>

          ${(o.paidStatus || "Ch∆∞a thanh to√°n") !== "ƒê√£ thanh to√°n"
            ? `<div style="margin-top:10px" class="inline">
                 <button class="btn" onclick="payFromHistory(${o.id})">Thanh to√°n b·∫±ng s·ªë d∆∞</button>
               </div>`
            : ""
          }
        </div>
      </div>
    `).join("");
  }

  async function payFromHistory(orderId){
    try{
      await payOrderByBalance(orderId);
      alert("Thanh to√°n b·∫±ng s·ªë d∆∞ th√†nh c√¥ng!");
      await reloadAll();
    }catch(e){
      alert(e.message);
    }
  }

  // ===== TOPUP MB =====
  async function createTopup() {
    const amt = Number(amount.value || 0);
    if (amt <= 0) return alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");

    const r = await fetch("/api/topup", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username: u.username, amount: amt, method: method.value })
    });
    const d = await r.json();
    if(!r.ok) return alert(d.msg || "L·ªói t·∫°o m√£ n·∫°p");

    localStorage.setItem("pay_topup", JSON.stringify(d.topup));
    location.href = "payment.html?type=topup";
  }

  async function loadTopups() {
    const r = await fetch("/api/topups/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { topups.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c n·∫°p</div>`; return; }
    if(!d.length) { topups.innerHTML = `<div class="muted">Ch∆∞a c√≥ l·ªãch s·ª≠ n·∫°p</div>`; return; }

    topups.innerHTML = d.map(t => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${t.method} ‚Ä¢ ${formatVND(t.amount)}</div>
          <div class="row-sub">
            <b>M√£:</b> ${t.code} ‚Ä¢ ${t.time}<br>
            <b>Tr·∫°ng th√°i:</b> ${t.status}
          </div>
        </div>
      </div>
    `).join("");
  }

  // ===== CARD TOPUP =====
  async function createCardTopup(){
    cardMsg.textContent = "";
    try{
      const body = {
        username: u.username,
        provider: cardProvider.value,
        amount: Number(cardAmount.value),
        serial: cardSerial.value,
        pin: cardPin.value
      };

      const r = await fetch("/api/cardtopup",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      const d = await r.json();
      if(!r.ok) throw new Error(d.msg || "L·ªói n·∫°p th·∫ª");

      cardMsg.textContent = `ƒê√£ g·ª≠i th·∫ª. M√£: ${d.card.code} ‚Ä¢ Nh·∫≠n: ${formatVND(d.card.netAmount)}`;
      cardSerial.value = "";
      cardPin.value = "";

      await loadCardTopups();
      await refreshMe();
    }catch(e){
      cardMsg.textContent = e.message;
    }
  }

  async function loadCardTopups(){
    const r = await fetch("/api/cardtopups/" + encodeURIComponent(u.username));
    const d = await r.json();
    if(!r.ok) { cardTopups.innerHTML = `<div class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ th·∫ª</div>`; return; }
    if(!d.length) { cardTopups.innerHTML = `<div class="muted">Ch∆∞a c√≥ n·∫°p th·∫ª</div>`; return; }

    cardTopups.innerHTML = d.map(c => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${c.provider} ‚Ä¢ ${formatVND(c.amount)}</div>
          <div class="row-sub">
            <b>M√£:</b> ${c.code} ‚Ä¢ ${c.time}<br>
            <b>Ph√≠:</b> ${c.feePercent}% ‚Üí <b>Nh·∫≠n:</b> ${formatVND(c.netAmount)}<br>
            <b>Tr·∫°ng th√°i:</b> ${c.status}${c.adminNote ? ` ‚Ä¢ <b>Admin:</b> ${c.adminNote}` : ""}
          </div>
        </div>
      </div>
    `).join("");
  }

  // ===== RELOAD ALL =====
  async function reloadAll() {
    await refreshMe();
    await loadOrders();
    await loadTopups();
    await loadCardTopups();
  }

  // init
  renderServices();
  reloadAll();
</script>
</body>
  </html>
