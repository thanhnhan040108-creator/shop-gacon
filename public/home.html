<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home - Shop Gà Con</title>
  <link rel="stylesheet" href="/public/app.css" />
</head>
<body>
  <div class="topbar">
    <div>
      <div class="brand">Home</div>
      <div class="muted" id="hello">...</div>
    </div>
    <div class="row">
      <span class="badge">Số dư: <b id="bal">0</b>đ</span>
      <button class="btn" id="logout">Đăng xuất</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2>Dịch vụ VOCALA</h2>
      <div class="muted">Chọn dịch vụ → ghi chú → tạo đơn (trừ số dư).</div>
      <hr>
      <div id="services"></div>
    </div>

    <div class="card">
      <h2>Nạp tiền</h2>
      <div class="grid2">
        <div class="card">
          <h3>MB Bank</h3>
          <div class="row">
            <input class="input" id="mbAmount" type="number" min="1000" placeholder="Số tiền">
            <button class="btn primary" id="mbCreate">Tạo mã nạp</button>
          </div>
          <div class="muted" id="mbMsg" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3>Thẻ cào</h3>
          <div class="row">
            <select class="input" id="telco">
              <option>Vinaphone</option>
              <option>Mobiphone</option>
              <option>Viettel</option>
              <option>Garena</option>
              <option>Zing</option>
            </select>
            <select class="input" id="value">
              <option value="20000">20k</option>
              <option value="50000">50k</option>
              <option value="100000">100k</option>
              <option value="200000">200k</option>
              <option value="500000">500k</option>
            </select>
          </div>
          <div class="row">
            <input class="input" id="serial" placeholder="Serial">
            <input class="input" id="pin" placeholder="Mã thẻ">
          </div>
          <button class="btn primary" id="cardSend">Gửi thẻ</button>
          <div class="muted" id="cardMsg" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Lịch sử</h2>
      <button class="btn" id="reload">Tải lại</button>
      <hr>
      <div id="history"></div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
function money(n){ return (Number(n)||0).toLocaleString("vi-VN"); }

async function get(url){
  const r = await fetch(url);
  const j = await r.json().catch(()=>({ok:false}));
  if(!r.ok) throw new Error(j.message || "Request lỗi");
  return j;
}
async function post(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({ok:false,message:"Lỗi JSON"}));
  if(!r.ok) throw new Error(j.message || "Request lỗi");
  return j;
}

async function loadMe(){
  const me = await get("/api/me");
  $("hello").textContent = "Xin chào: " + me.user.username;
  $("bal").textContent = money(me.user.balance);
}

function renderServices(groups){
  const wrap = $("services");
  wrap.innerHTML = "";
  groups.forEach(g=>{
    const box = document.createElement("div");
    box.className = "card";
    box.innerHTML = `<h3>${g.group}</h3><hr><div class="list"></div>`;
    const list = box.querySelector(".list");

    g.items.forEach(it=>{
      const item = document.createElement("div");
      item.className = "card";
      item.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div style="font-weight:800">${it.name}</div>
            <div class="muted">${money(it.price)}đ</div>
            <textarea class="input note" placeholder="Ghi chú đơn (acc/mk/yêu cầu...)"></textarea>
          </div>
          <div>
            <button class="btn primary buy">Tạo đơn</button>
          </div>
        </div>
      `;
      item.querySelector(".buy").onclick = async ()=>{
        const note = item.querySelector(".note").value;
        try{
          await post("/api/orders", { serviceKey: it.key, note });
          alert("Tạo đơn thành công!");
          await loadMe();
          await loadHistory();
        }catch(e){ alert(e.message); }
      };
      list.appendChild(item);
    });

    wrap.appendChild(box);
  });
}

async function loadServices(){
  const s = await get("/api/services");
  renderServices(s.services);
}

async function loadHistory(){
  const h = await get("/api/history");
  const wrap = $("history");

  const orders = (h.orders||[]).map(o=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>${o.serviceName}</b>
        <span class="badge">${o.status}</span>
      </div>
      <div class="muted">Mã: <b>${o.id}</b> • ${money(o.price)}đ</div>
      <div class="muted">Ghi chú: ${o.note ? o.note.replaceAll("<","&lt;") : "(không có)"}</div>
    </div>
  `).join("");

  const topups = (h.topups||[]).map(t=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>${t.method}</b>
        <span class="badge">${t.status}</span>
      </div>
      <div class="muted">Mã: <b>${t.code}</b> • Gửi: ${money(t.amount)}đ • Nhận: ${money(t.total)}đ</div>
      ${t.method==="MB Bank" ? `<div style="margin-top:10px"><a class="btn primary" href="/payment?id=${encodeURIComponent(t.id)}">Mở cổng thanh toán</a></div>` : ""}
    </div>
  `).join("");

  wrap.innerHTML = `
    <h3>Đơn hàng</h3>
    ${orders || `<div class="muted">Chưa có đơn.</div>`}
    <hr>
    <h3>Nạp tiền</h3>
    ${topups || `<div class="muted">Chưa có nạp.</div>`}
  `;
}

$("logout").onclick = async ()=>{
  await post("/api/logout", {});
  location.href = "/";
};

$("mbCreate").onclick = async ()=>{
  $("mbMsg").textContent = "";
  try{
    const amt = Number($("mbAmount").value);
    const r = await post("/api/topup/mb", { amount: amt });
    $("mbMsg").innerHTML = `Tạo mã nạp: <b>${r.topup.code}</b> • <a href="/payment?id=${encodeURIComponent(r.topup.id)}">Mở cổng thanh toán</a>`;
    await loadHistory();
  }catch(e){ $("mbMsg").textContent = e.message; }
};

$("cardSend").onclick = async ()=>{
  $("cardMsg").textContent = "";
  try{
    const telco = $("telco").value;
    const value = Number($("value").value);
    const serial = $("serial").value.trim();
    const pin = $("pin").value.trim();
    const r = await post("/api/topup/card", { telco, value, serial, pin });
    $("cardMsg").innerHTML = `Đã gửi • Mã: <b>${r.topup.code}</b> • Nhận dự kiến: <b>${money(r.topup.total)}đ</b>`;
    $("serial").value = ""; $("pin").value = "";
    await loadHistory();
  }catch(e){ $("cardMsg").textContent = e.message; }
};

$("reload").onclick = loadHistory;

(async ()=>{
  try{
    await loadMe();
    await loadServices();
    await loadHistory();
  }catch(e){
    location.href = "/";
  }
})();
</script>
</body>
</html>
