<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>SHOP-GACON</h1>
      </div>
      <div class="right">
        <div class="pill">User: <b id="uName">-</b></div>
        <div class="pill">Số dư: <b id="uBal">0</b>đ</div>
        <button class="btn-secondary" id="btnLogout">Đăng xuất</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Dịch vụ (Blox Fruit)</h2>
        <div class="muted">Dịch vụ được chia theo mục. Nhấn “Mua” để trừ số dư và lưu lịch sử.</div>
        <div id="services"></div>
      </div>

      <div>
        <div class="card">
          <h2>Nạp tiền (MB Bank)</h2>
          <div class="muted">Chuyển khoản theo QR và nhập đúng <b>nội dung</b> để admin duyệt nhanh.</div>

          <div class="hr"></div>

          <div class="bank-box">
            <div>
              <div><b>Ngân hàng:</b> MB Bank</div>
              <div><b>Chủ TK:</b> VAN VIET THANH NHAN</div>
              <div><b>Số TK:</b> 7475040109</div>
              <div class="muted">Tạo mã nạp bên dưới, copy đúng vào “Nội dung chuyển khoản”.</div>
            </div>
            <div class="bank-qr">
              <img src="/mb-qr.jpg" alt="QR MB Bank" />
            </div>
          </div>

          <div class="row">
            <input id="topupAmount" type="number" placeholder="Số tiền cần nạp (VD: 50000)" />
            <button id="btnCreateTopup">Tạo mã nạp</button>
          </div>

          <div id="topupResult" class="note" style="display:none"></div>

          <div class="row">
            <button id="btnIHavePaid" class="btn-secondary" disabled>Tôi đã chuyển khoản</button>
          </div>
        </div>

        <div class="card section-title">
          <h2>Lịch sử nạp</h2>
          <div id="topupHistory" class="list"></div>
        </div>

        <div class="card section-title">
          <h2>Lịch sử mua</h2>
          <div id="orderHistory" class="list"></div>
        </div>

        <div id="msg" class="note" style="display:none"></div>
      </div>
    </div>
  </div>

<script>
const username = localStorage.getItem("username");
if(!username) location.href = "/";

uName.textContent = username;

btnLogout.onclick = () => {
  localStorage.removeItem("username");
  localStorage.removeItem("gmail");
  location.href = "/";
};

function money(n){
  return Number(n).toLocaleString("vi-VN");
}
function showMsg(text){
  msg.style.display = "block";
  msg.innerText = text;
}
function badge(status){
  return `<span class="badge ${status}">${status}</span>`;
}

async function refreshBalance(){
  const r = await fetch("/api/balance?username=" + encodeURIComponent(username));
  const d = await r.json();
  uBal.textContent = money(d.balance || 0);
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadServices(){
  const r = await fetch("/api/services");
  const d = await r.json();
  const list = d.services || [];

  // group by category
  const groups = {};
  for(const s of list){
    groups[s.category] = groups[s.category] || [];
    groups[s.category].push(s);
  }

  let html = "";
  Object.keys(groups).forEach(cat => {
    html += `<div class="card" style="margin-top:12px;background:rgba(12,23,45,.45)">
      <h2 style="margin:0 0 8px 0">${escapeHtml(cat)}</h2>
      <div class="list">
        ${groups[cat].map(s => `
          <div class="item">
            <div>
              <b>${escapeHtml(s.name)}</b>
              ${s.note ? `<div class="muted">${escapeHtml(s.note)}</div>` : ``}
              <div class="muted">Giá: <b>${s.price > 0 ? money(s.price) + "đ" : "IB báo giá"}</b></div>
            </div>
            <div>
              <button ${s.price>0 ? "" : "disabled"} data-id="${s.id}">Mua</button>
            </div>
          </div>
        `).join("")}
      </div>
    </div>`;
  });

  services.innerHTML = html;

  services.querySelectorAll("button[data-id]").forEach(btn => {
    btn.onclick = async () => {
      const serviceId = btn.getAttribute("data-id");
      const r2 = await fetch("/api/orders", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ username, serviceId })
      });
      const o = await r2.json();
      if(!o.ok) return showMsg(o.msg || "Mua thất bại");
      showMsg("Mua thành công!");
      await refreshBalance();
      await loadOrders();
    };
  });
}

async function loadTopups(){
  const r = await fetch("/api/topups?username=" + encodeURIComponent(username));
  const d = await r.json();
  const list = d.topups || [];
  if(!list.length){
    topupHistory.innerHTML = `<div class="muted">Chưa có giao dịch nạp.</div>`;
    return;
  }
  topupHistory.innerHTML = list.map(t => `
    <div class="item">
      <div>
        <b>${money(t.amount)}đ</b> ${badge(t.status)}
        <div class="muted">Mã nội dung: <span class="code">${t.code}</span></div>
        <div class="muted">${new Date(t.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

async function loadOrders(){
  const r = await fetch("/api/orders?username=" + encodeURIComponent(username));
  const d = await r.json();
  const list = d.orders || [];
  if(!list.length){
    orderHistory.innerHTML = `<div class="muted">Chưa có lịch sử mua.</div>`;
    return;
  }
  orderHistory.innerHTML = list.map(o => `
    <div class="item">
      <div>
        <b>${escapeHtml(o.serviceName)}</b> ${badge(o.status)}
        ${o.note ? `<div class="muted">${escapeHtml(o.note)}</div>` : ``}
        <div class="muted">${money(o.amount)}đ • ${new Date(o.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

// ==== TOPUP create ====
let lastTopupId = null;

function showTopupBox(html){
  topupResult.style.display = "block";
  topupResult.innerHTML = html;
}

btnCreateTopup.onclick = async () => {
  const amount = Number(topupAmount.value || 0);
  if(amount < 1000) return showMsg("Nhập số tiền >= 1.000đ");

  const r = await fetch("/api/topups", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ username, amount })
  });
  const d = await r.json();
  if(!d.ok) return showMsg(d.msg || "Lỗi tạo mã nạp");

  lastTopupId = d.topup.id;
  btnIHavePaid.disabled = false;

  showTopupBox(
    `Mã nạp của bạn: <span class="code">${d.topup.code}</span>\n` +
    `Hãy chuyển khoản với <b>Nội dung</b>: <span class="code">${d.topup.code}</span>\n` +
    `Admin sẽ duyệt sau khi kiểm tra giao dịch.`
  );

  await loadTopups();
};

btnIHavePaid.onclick = async () => {
  if(!lastTopupId) return showMsg("Bạn chưa tạo mã nạp");
  showMsg("Đã ghi nhận. Vui lòng chờ admin duyệt.");
};

(async function init(){
  await refreshBalance();
  await loadServices();
  await loadTopups();
  await loadOrders();
})();
</script>
</body>
                </html>
