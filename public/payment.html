<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>Cổng thanh toán</h1>
        <div class="sub">Chuyển khoản đúng nội dung để admin duyệt</div>
      </div>
      <div class="row">
        <button class="btn" onclick="location.href='/home.html'">← Quay lại</button>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="head"><h2>Thông tin đơn / nạp</h2></div>
        <div class="body" id="info">Đang tải...</div>
      </div>

      <div class="card">
        <div class="head"><h2>QR MB Bank</h2></div>
        <div class="body" id="bankBox">Đang tải...</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><b id="tTitle">Thông báo</b><div id="tMsg" class="muted"></div></div>

<script>
  const toast = (title, msg) => {
    document.getElementById('tTitle').textContent = title;
    document.getElementById('tMsg').textContent = msg || '';
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2600);
  };
  function fmtVND(n){
    try { return new Intl.NumberFormat('vi-VN').format(n) + 'đ'; } catch(e){ return n + 'đ'; }
  }
  function getToken(){ return localStorage.getItem('userToken') || ''; }
  function requireLogin(){
    if(!getToken()){ location.href='/index.html'; return false; }
    return true;
  }
  async function api(url){
    const r = await fetch(url, { headers: { 'x-auth-token': getToken() }});
    const j = await r.json().catch(()=>({ok:false,message:'JSON lỗi'}));
    if(!r.ok) throw new Error(j.message || 'Request lỗi');
    return j;
  }

  (async function init(){
    if(!requireLogin()) return;
    const q = new URLSearchParams(location.search);
    const orderId = q.get('orderId');
    const topupId = q.get('topupId');

    try{
      const j = await api(`/api/payment/info?orderId=${encodeURIComponent(orderId||'')}&topupId=${encodeURIComponent(topupId||'')}`);

      const bank = j.bank;
      const info = document.getElementById('info');
      const bankBox = document.getElementById('bankBox');

      let content = '';
      let amount = 0;

      if(j.order){
        amount = Number(j.order.price||0);
        content = `PAY_${j.order.id}`.slice(0, 18);
        info.innerHTML = `
          <div class="kv"><b>Thanh toán đơn hàng</b><span class="tag warn">${j.order.status}</span></div>
          <div class="hr"></div>
          <div><b>Dịch vụ:</b> ${j.order.serviceName}</div>
          <div class="muted">${j.order.note || ''}</div>
          <div class="hr"></div>
          <div class="kv"><b>Số tiền</b><span>${fmtVND(amount)}</span></div>
          <div class="kv"><b>Nội dung chuyển khoản</b><span>${content}</span></div>
          <div class="muted" style="margin-top:8px">Sau khi chuyển khoản, admin sẽ kiểm tra và duyệt.</div>
        `;
      }else if(j.topup){
        amount = Number(j.topup.amount||0);
        content = j.topup.code || `NAP_${j.topup.id}`.slice(0, 18);
        info.innerHTML = `
          <div class="kv"><b>Nạp tiền (Bank)</b><span class="tag warn">${j.topup.status}</span></div>
          <div class="hr"></div>
          <div class="kv"><b>Số tiền</b><span>${fmtVND(amount)}</span></div>
          <div class="kv"><b>Nội dung chuyển khoản</b><span>${content}</span></div>
          <div class="muted" style="margin-top:8px">Chuyển khoản đúng nội dung để duyệt nhanh.</div>
        `;
      }else{
        info.innerHTML = `<div class="muted">Không tìm thấy đơn/topup. Quay lại Home và tạo đơn hoặc tạo mã nạp.</div>`;
      }

      bankBox.innerHTML = `
        <div class="kv"><b>Ngân hàng</b><span>${bank.name}</span></div>
        <div class="kv"><b>Chủ TK</b><span>${bank.accountName}</span></div>
        <div class="kv"><b>Số TK</b><span>${bank.accountNumber}</span></div>
        <div class="hr"></div>
        <img src="${bank.qrImage}" alt="QR MB" style="width:100%;max-width:420px;border-radius:16px;border:1px solid rgba(255,255,255,.12)" />
        <div class="hr"></div>
        <div class="muted">Gợi ý: copy nội dung chuyển khoản cho đúng.</div>
      `;
    }catch(e){
      toast('Lỗi', e.message);
      document.getElementById('info').textContent = 'Lỗi: ' + e.message;
      document.getElementById('bankBox').textContent = 'Lỗi: ' + e.message;
    }
  })();
</script>
</body>
  </html>
