<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Shop Gà Con</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <div class="topbar">
    <div>
      <div class="title">Admin Dashboard</div>
      <div class="muted">Quản lý đơn • nạp MB • nạp thẻ</div>
    </div>
    <div class="top-actions">
      <button class="btn ghost" onclick="reload()">Tải lại</button>
      <button class="btn" onclick="logout()">Đăng xuất</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">

      <div class="card">
        <h3>Topup (MB) - Duyệt nạp</h3>
        <div id="topups" class="list"></div>

        <div class="subcard">
          <h3>Card Topups - Duyệt thẻ cào</h3>
          <div id="cardTopups" class="list"></div>
        </div>
      </div>

      <div class="card">
        <div class="row-between">
          <h3>Orders (Đơn hàng)</h3>
          <select id="orderFilter" onchange="renderOrders()">
            <option value="all">Tất cả</option>
            <option value="unpaid">Chưa thanh toán</option>
            <option value="paid">Đã thanh toán</option>
            <option value="doing">Đang làm</option>
            <option value="done">Hoàn thành</option>
            <option value="reject">Từ chối</option>
          </select>
        </div>

        <div class="muted" style="margin-top:8px">
          Đơn <b>chưa thanh toán</b> bị khóa: chỉ cho <b>Chờ xử lý</b> hoặc <b>Từ chối</b>.
        </div>

        <div id="orders" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Users</h3>
        <div id="users" class="list"></div>
      </div>

    </div>
  </div>

<script>
  const token = localStorage.getItem("adminToken");
  if(!token) location.href = "admin.html";

  let CACHE = { users: [], orders: [], topups: [], cardTopups: [] };

  function formatVND(n){ return Number(n||0).toLocaleString("vi-VN")+"đ"; }

  function logout(){
    localStorage.removeItem("adminToken");
    location.href = "admin.html";
  }

  async function api(url, body){
    const r = await fetch(url,{
      method:"POST",
      headers:{ "Content-Type":"application/json","x-admin-token": token },
      body: JSON.stringify(body||{})
    });
    const d = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(d.msg || "Request fail");
    return d;
  }

  async function load(){
    const r = await fetch("/api/admin/data", { headers: { "x-admin-token": token } });
    const data = await r.json();
    if(!r.ok) { alert("Token hết hạn, login lại"); logout(); return; }

    CACHE = {
      users: data.users || [],
      orders: data.orders || [],
      topups: data.topups || [],
      cardTopups: data.cardTopups || []
    };

    renderTopups();
    renderCardTopups();
    renderOrders();
    renderUsers();
  }

  // ===== TOPUPS MB =====
  function renderTopups(){
    const t = CACHE.topups;
    topups.innerHTML = t.length ? t.map(x => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${x.username} • ${formatVND(x.amount)} • ${x.method}</div>
          <div class="row-sub"><b>Mã:</b> ${x.code} • ${x.time} • <b>${x.status}</b></div>
        </div>
        <div class="row-actions">
          ${x.status === "Chờ duyệt" ? `
            <button class="btn" onclick="approveTopup(${x.id}, true)">Duyệt</button>
            <button class="btn ghost" onclick="approveTopup(${x.id}, false)">Từ chối</button>
          ` : `<span class="pill">${x.status}</span>`}
        </div>
      </div>
    `).join("") : `<div class="muted">Chưa có topup MB</div>`;
  }

  async function approveTopup(id, approve){
    await api("/api/admin/topup-approve", { id, approve });
    await load();
  }

  // ===== CARD TOPUPS =====
  function renderCardTopups(){
    const t = CACHE.cardTopups;
    cardTopups.innerHTML = t.length ? t.map(x => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${x.username} • ${x.provider} • ${formatVND(x.amount)}</div>
          <div class="row-sub">
            <b>Mã:</b> ${x.code} • ${x.time}<br>
            <b>Phí:</b> ${x.feePercent}% → <b>Nhận:</b> ${formatVND(x.netAmount)}<br>
            <b>Serial:</b> ${x.serial} • <b>Mã thẻ:</b> ${x.pin}<br>
            <b>Trạng thái:</b> ${x.status}${x.adminNote ? ` • <b>Note:</b> ${x.adminNote}` : ""}
          </div>

          <div style="margin-top:10px" class="inline">
            <input id="cardnote_${x.id}" placeholder="Ghi chú admin" />
            ${x.status === "Chờ duyệt" ? `
              <button class="btn" onclick="approveCard(${x.id}, true)">Duyệt</button>
              <button class="btn ghost" onclick="approveCard(${x.id}, false)">Từ chối</button>
            ` : `<span class="pill">${x.status}</span>`}
          </div>
        </div>
      </div>
    `).join("") : `<div class="muted">Chưa có nạp thẻ</div>`;
  }

  async function approveCard(id, approve){
    const adminNote = document.getElementById("cardnote_"+id).value;
    await api("/api/admin/card-approve", { id, approve, adminNote });
    await load();
  }

  // ===== ORDERS A+B =====
  function matchesFilter(order, filter){
    const paid = (order.paidStatus || "Chưa thanh toán");
    const st = (order.status || "Chờ xử lý");

    if(filter === "all") return true;
    if(filter === "unpaid") return paid === "Chưa thanh toán";
    if(filter === "paid") return paid === "Đã thanh toán";
    if(filter === "doing") return st === "Đang làm";
    if(filter === "done") return st === "Hoàn thành";
    if(filter === "reject") return st === "Từ chối";
    return true;
  }

  function renderOrders(){
    const filter = (document.getElementById("orderFilter")?.value) || "all";
    const list = CACHE.orders.filter(o => matchesFilter(o, filter));

    orders.innerHTML = list.length ? list.map(x => {
      const paidStatus = x.paidStatus || "Chưa thanh toán";
      const payCode = x.payCode || "(chưa có mã)";
      const locked = (paidStatus !== "Đã thanh toán");

      const options = locked
        ? ["Chờ xử lý", "Từ chối"]
        : ["Chờ xử lý", "Đang làm", "Hoàn thành", "Từ chối"];

      const optHtml = options.map(s => `
        <option ${x.status === s ? "selected":""}>${s}</option>
      `).join("");

      return `
        <div class="row">
          <div class="row-main">
            <div class="row-title">${x.username} • ${x.service} • ${formatVND(x.price)}</div>
            <div class="row-sub">
              <b>Thanh toán:</b> ${paidStatus} • <b>Mã:</b> ${payCode}<br>
              <b>Ghi chú:</b> ${x.note || "(trống)"}<br>
              <b>Trạng thái:</b> ${x.status}${x.adminNote ? ` • <b>Admin:</b> ${x.adminNote}`:""}<br>
              ${x.time}
            </div>

            <div style="margin-top:10px" class="inline">
              <select id="st_${x.id}">${optHtml}</select>
              <input id="an_${x.id}" placeholder="Ghi chú admin"
                value="${(x.adminNote||"").replace(/"/g,'&quot;')}" />
              <button class="btn" onclick="updateOrder(${x.id}, ${locked})">Lưu</button>
              <button class="btn ghost" onclick="deleteOrder(${x.id})">Xoá</button>
              <button class="btn" onclick="markPaid(${x.id}, true)">Đã thanh toán</button>
              <button class="btn ghost" onclick="markPaid(${x.id}, false)">Chưa thanh toán</button>
            </div>

            ${locked ? `<div class="msg">Chưa thanh toán → không cho “Đang làm/Hoàn thành”.</div>` : ``}
          </div>
        </div>
      `;
    }).join("") : `<div class="muted">Không có đơn theo bộ lọc này</div>`;
  }

  async function updateOrder(id, locked){
    const status = document.getElementById("st_"+id).value;
    const adminNote = document.getElementById("an_"+id).value;

    if(locked && (status === "Đang làm" || status === "Hoàn thành")){
      alert("Đơn chưa thanh toán nên không thể chuyển sang Đang làm/Hoàn thành.");
      return;
    }

    await api("/api/admin/order-update", { id, status, adminNote });
    await load();
  }

  async function markPaid(id, paid){
    await api("/api/admin/order-paid", { id, paid });
    await load();
  }

  async function deleteOrder(id){
    if(!confirm("Xoá đơn này?")) return;
    await api("/api/admin/order-delete", { id });
    await load();
  }

  // ===== USERS =====
  function renderUsers(){
    const u = CACHE.users;
    users.innerHTML = u.length ? u.map(x => `
      <div class="row">
        <div class="row-main">
          <div class="row-title">${x.username}</div>
          <div class="row-sub">${x.email} • Số dư: <b>${formatVND(x.balance)}</b></div>
        </div>
        <div class="row-actions">
          <button class="btn ghost" onclick="deleteUser('${x.username}')">Xoá user</button>
        </div>
      </div>
    `).join("") : `<div class="muted">Chưa có user</div>`;
  }

  async function deleteUser(username){
    if(!confirm("Xoá user '"+username+"' ? (xoá cả đơn + topup + thẻ)")) return;
    await api("/api/admin/user-delete", { username });
    await load();
  }

  async function reload(){ await load(); }
  load();
</script>
</body>
</html>
