<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Shop G√† Con</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body class="page">
  <div class="container">
    <div class="topbar">
      <div>
        <b>Admin Dashboard</b>
        <div id="who" class="muted" style="font-size:12px">...</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="home.html">Home</a>
        <button class="btn" id="btnLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="col">
        <div class="card">
          <h2>Th√™m d·ªãch v·ª•</h2>
          <div class="muted" style="font-size:12px">
            (B·∫°n ƒë√£ c√≥ s·∫µn d·ªãch v·ª• trong Data.json r·ªìi. Form n√†y ƒë·ªÉ th√™m/s·ª≠a sau.)
          </div>
          <div class="hr"></div>

          <div class="field">
            <label>Category</label>
            <input id="svcCat" placeholder="V√≠ d·ª•: Bounty Hunt üí∏" />
          </div>
          <div class="field">
            <label>Title</label>
            <input id="svcTitle" placeholder="V√≠ d·ª•: 1m Bounty h·∫£i t·∫∑c" />
          </div>
          <div class="field">
            <label>Desc</label>
            <input id="svcDesc" placeholder="M√¥ t·∫£ th√™m" />
          </div>
          <div class="field">
            <label>Price (VND) (0 = IB b√°o gi√°)</label>
            <input id="svcPrice" type="number" placeholder="10000" />
          </div>
          <button class="btn primary" id="btnAddSvc">Th√™m</button>
          <div id="svcMsg" class="muted" style="margin-top:10px"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>Danh s√°ch d·ªãch v·ª•</h2>
          <button class="btn" id="btnReloadSvc">T·∫£i l·∫°i</button>
          <div id="svcList" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>ƒê∆°n h√†ng</h2>
          <div class="muted" style="font-size:12px">ƒê·ªïi tr·∫°ng th√°i + ghi ch√∫ admin.</div>
          <div class="hr"></div>
          <button class="btn" id="btnReloadOrders">T·∫£i l·∫°i</button>
          <div id="orderList" style="margin-top:10px"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>Y√™u c·∫ßu n·∫°p</h2>
          <div class="muted" style="font-size:12px">Duy·ªát s·∫Ω c·ªông ti·ªÅn v√†o s·ªë d∆∞ user.</div>
          <div class="hr"></div>
          <button class="btn" id="btnReloadTopups">T·∫£i l·∫°i</button>
          <div id="topList" style="margin-top:10px"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>User</h2>
          <button class="btn" id="btnReloadUsers">T·∫£i l·∫°i</button>
          <div id="userList" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function token(){ return localStorage.getItem("token") || ""; }
    async function api(path, method="GET", body=null){
      const headers = {};
      if (token()) headers["Authorization"] = "Bearer " + token();
      if (body) headers["Content-Type"] = "application/json";
      const res = await fetch(path, { method, headers, body: body?JSON.stringify(body):null });
      return res.json();
    }
    function money(v){ return (Number(v||0)).toLocaleString("vi-VN") + "ƒë"; }
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    (async () => {
      if(!token()) return location.href="admin.html";
      const me = await api("/api/me");
      if(!me.ok) return location.href="admin.html";
      if(me.user.role !== "admin") return location.href="home.html";
      document.getElementById("who").textContent = `Admin: ${me.user.username}`;

      loadServices();
      loadOrders();
      loadTopups();
      loadUsers();
    })();

    document.getElementById("btnLogout").onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("me");
      location.href = "admin.html";
    };

    // ===== Services =====
    async function loadServices(){
      const box = document.getElementById("svcList");
      box.innerHTML = "ƒêang t·∫£i...";
      const data = await api("/api/services");
      if(!data.ok){ box.innerHTML="L·ªói"; return; }

      if(!data.services.length){ box.innerHTML="<div class='muted'>Ch∆∞a c√≥ d·ªãch v·ª•.</div>"; return; }

      let html = `<table class="table"><thead>
        <tr><th>ID</th><th>Category</th><th>Title</th><th>Price</th><th>Action</th></tr>
      </thead><tbody>`;
      for(const s of data.services){
        html += `<tr>
          <td>${esc(s.id)}</td>
          <td class="muted" style="font-size:12px">${esc(s.category)}</td>
          <td><b>${esc(s.title)}</b><div class="muted" style="font-size:12px">${esc(s.desc||"")}</div></td>
          <td>${Number(s.price)<=0 ? "IB" : money(s.price)}</td>
          <td>
            <button class="btn" onclick="editSvc('${esc(s.id)}')">S·ª≠a</button>
            <button class="btn" onclick="delSvc('${esc(s.id)}')">Xo√°</button>
          </td>
        </tr>`;
      }
      html += `</tbody></table>`;
      box.innerHTML = html;
    }

    document.getElementById("btnAddSvc").onclick = async () => {
      const category = document.getElementById("svcCat").value.trim();
      const title = document.getElementById("svcTitle").value.trim();
      const desc = document.getElementById("svcDesc").value.trim();
      const price = Number(document.getElementById("svcPrice").value || 0);
      const msg = document.getElementById("svcMsg");
      msg.textContent = "ƒêang th√™m...";

      const data = await api("/api/admin/services","POST",{category,title,desc,price});
      if(!data.ok){ msg.textContent = "L·ªói: " + data.error; return; }
      msg.textContent = "ƒê√£ th√™m!";
      loadServices();
    };

    document.getElementById("btnReloadSvc").onclick = () => loadServices();

    window.delSvc = async (id) => {
      if(!confirm("Xo√° d·ªãch v·ª• n√†y?")) return;
      const data = await api("/api/admin/services/"+id,"DELETE");
      if(!data.ok) alert("L·ªói: "+data.error);
      loadServices();
    };

    window.editSvc = async (id) => {
      const category = prompt("Category m·ªõi (b·ªè tr·ªëng gi·ªØ nguy√™n):");
      const title = prompt("Title m·ªõi (b·ªè tr·ªëng gi·ªØ nguy√™n):");
      const desc = prompt("Desc m·ªõi (b·ªè tr·ªëng gi·ªØ nguy√™n):");
      const priceStr = prompt("Price m·ªõi (b·ªè tr·ªëng gi·ªØ nguy√™n, 0 = IB):");
      const body = {};
      if(category) body.category = category;
      if(title) body.title = title;
      if(desc) body.desc = desc;
      if(priceStr !== null && priceStr !== "") body.price = Number(priceStr);

      const data = await api("/api/admin/services/"+id,"PUT",body);
      if(!data.ok) alert("L·ªói: "+data.error);
      loadServices();
    };

    // ===== Orders =====
    async function loadOrders(){
      const box = document.getElementById("orderList");
      box.innerHTML = "ƒêang t·∫£i...";
      const data = await api("/api/admin/orders");
      if(!data.ok){ box.innerHTML="L·ªói"; return; }
      if(!data.orders.length){ box.innerHTML="<div class='muted'>Ch∆∞a c√≥ ƒë∆°n.</div>"; return; }

      let html = `<table class="table"><thead>
        <tr><th>M√£</th><th>User</th><th>D·ªãch v·ª•</th><th>Gi√°</th><th>Tr·∫°ng th√°i</th><th>Admin note</th><th>Action</th></tr>
      </thead><tbody>`;
      for(const o of data.orders){
        html += `<tr>
          <td>${esc(o.id)}</td>
          <td><b>${esc(o.username)}</b></td>
          <td><b>${esc(o.serviceTitle)}</b><div class="muted" style="font-size:12px">${esc(o.note||"")}</div></td>
          <td>${money(o.price)}</td>
          <td><span class="badge">${esc(o.status)}</span></td>
          <td class="muted" style="font-size:12px">${esc(o.adminNote||"")}</td>
          <td><button class="btn" onclick="updateOrder('${esc(o.id)}')">C·∫≠p nh·∫≠t</button></td>
        </tr>`;
      }
      html += `</tbody></table>`;
      box.innerHTML = html;
    }
    document.getElementById("btnReloadOrders").onclick = () => loadOrders();

    window.updateOrder = async (id) => {
      const status = prompt("Nh·∫≠p tr·∫°ng th√°i (VD: Ch·ªù x√°c nh·∫≠n / ƒêang l√†m / Ho√†n th√†nh / Hu·ª∑):");
      const adminNote = prompt("Ghi ch√∫ admin:");
      const data = await api("/api/admin/orders/"+id,"PUT",{status,adminNote});
      if(!data.ok) alert("L·ªói: "+data.error);
      loadOrders();
    };

    // ===== Topups =====
    async function loadTopups(){
      const box = document.getElementById("topList");
      box.innerHTML = "ƒêang t·∫£i...";
      const data = await api("/api/admin/topups");
      if(!data.ok){ box.innerHTML="L·ªói"; return; }
      if(!data.topups.length){ box.innerHTML="<div class='muted'>Ch∆∞a c√≥ y√™u c·∫ßu n·∫°p.</div>"; return; }

      let html = `<table class="table"><thead>
        <tr><th>M√£</th><th>User</th><th>S·ªë ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>N·ªôi dung CK</th><th>Admin</th><th>Action</th></tr>
      </thead><tbody>`;
      for(const t of data.topups){
        html += `<tr>
          <td>${esc(t.id)}</td>
          <td><b>${esc(t.username)}</b></td>
          <td>${money(t.amount)}</td>
          <td><span class="badge">${esc(t.status)}</span></td>
          <td class="muted" style="font-size:12px">${esc(t.transferNote||"")}</td>
          <td class="muted" style="font-size:12px">${esc(t.adminNote||"")}</td>
          <td><button class="btn" onclick="updateTopup('${esc(t.id)}')">C·∫≠p nh·∫≠t</button></td>
        </tr>`;
      }
      html += `</tbody></table>`;
      box.innerHTML = html;
    }
    document.getElementById("btnReloadTopups").onclick = () => loadTopups();

    window.updateTopup = async (id) => {
      const status = prompt("Nh·∫≠p tr·∫°ng th√°i (Ch·ªù duy·ªát / ƒê√£ duy·ªát / T·ª´ ch·ªëi):");
      const adminNote = prompt("Ghi ch√∫ admin:");
      const data = await api("/api/admin/topups/"+id,"PUT",{status,adminNote});
      if(!data.ok) alert("L·ªói: "+data.error);
      loadTopups();
      loadUsers();
    };

    // ===== Users =====
    async function loadUsers(){
      const box = document.getElementById("userList");
      box.innerHTML = "ƒêang t·∫£i...";
      const data = await api("/api/admin/users");
      if(!data.ok){ box.innerHTML="L·ªói"; return; }

      let html = `<table class="table"><thead>
        <tr><th>ID</th><th>User</th><th>Role</th><th>Balance</th><th>Action</th></tr>
      </thead><tbody>`;
      for(const u of data.users){
        html += `<tr>
          <td>${esc(u.id)}</td>
          <td><b>${esc(u.username)}</b></td>
          <td>${esc(u.role)}</td>
          <td>${money(u.balance)}</td>
          <td>${u.role==="admin" ? "<span class='muted'>-</span>" : `<button class="btn" onclick="delUser('${esc(u.id)}')">Xo√°</button>`}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      box.innerHTML = html;
    }
    document.getElementById("btnReloadUsers").onclick = () => loadUsers();

    window.delUser = async (id) => {
      if(!confirm("Xo√° user n√†y? (S·∫Ω xo√° lu√¥n ƒë∆°n + topup c·ªßa user)")) return;
      const data = await api("/api/admin/users/"+id,"DELETE");
      if(!data.ok) alert("L·ªói: "+data.error);
      loadUsers(); loadOrders(); loadTopups();
    };
  </script>
</body>
</html>
