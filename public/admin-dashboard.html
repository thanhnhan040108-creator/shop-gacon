<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>ADMIN DASHBOARD</h1>
      </div>
      <div class="right">
        <button class="btn-secondary" id="btnAdminLogout">Đăng xuất</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Yêu cầu nạp (PENDING)</h2>
        <div class="muted">Admin kiểm tra giao dịch ngân hàng rồi bấm “Duyệt”.</div>
        <div id="pendingTopups" class="list"></div>
      </div>

      <div>
        <div class="card">
          <h2>Danh sách Users</h2>
          <div id="users" class="list"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>Lịch sử mua</h2>
          <div id="orders" class="list"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const adminUser = localStorage.getItem("adminUser");
const adminPass = localStorage.getItem("adminPass");
if(!adminUser || !adminPass) location.href = "/admin.html";

document.getElementById("btnAdminLogout").onclick = () => {
  localStorage.removeItem("adminUser");
  localStorage.removeItem("adminPass");
  location.href = "/admin.html";
};

function badge(status){ return `<span class="badge ${status}">${status}</span>`; }

async function loadSummary(){
  const r = await fetch("/api/admin/summary", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ adminUser, adminPass })
  });
  const data = await r.json();
  if(!data.ok) { alert("Sai admin"); location.href="/admin.html"; return; }

  renderTopups(data.topups || []);
  renderUsers(data.users || []);
  renderOrders(data.orders || []);
}

function renderTopups(items){
  const pend = items.filter(t => t.status === "PENDING");
  const el = document.getElementById("pendingTopups");
  if(!pend.length){
    el.innerHTML = `<div class="muted">Không có yêu cầu nạp chờ duyệt.</div>`;
    return;
  }
  el.innerHTML = pend.map(t => `
    <div class="item">
      <div>
        <b>${t.username}</b> • ${Number(t.amount).toLocaleString()}đ ${badge(t.status)}
        <div class="muted">Mã nội dung: <span class="code">${t.code}</span></div>
        <div class="muted">${new Date(t.createdAt).toLocaleString()}</div>
      </div>
      <div>
        <button data-id="${t.id}">Duyệt</button>
      </div>
    </div>
  `).join("");

  el.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async () => {
      const topupId = btn.getAttribute("data-id");
      const r2 = await fetch("/api/admin/topups/approve", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ adminUser, adminPass, topupId })
      });
      const d2 = await r2.json();
      if(!d2.ok) return alert(d2.msg || "Duyệt thất bại");
      alert("✅ Đã duyệt và cộng tiền");
      await loadSummary();
    };
  });
}

function renderUsers(items){
  const el = document.getElementById("users");
  if(!items.length){
    el.innerHTML = `<div class="muted">Chưa có user.</div>`;
    return;
  }
  el.innerHTML = items.map(u => `
    <div class="item">
      <div>
        <b>${u.username}</b>
        <div class="muted">${u.gmail || ""}</div>
      </div>
      <div class="pill">Balance: <b>${Number(u.balance||0).toLocaleString()}đ</b></div>
    </div>
  `).join("");
}

function renderOrders(items){
  const el = document.getElementById("orders");
  if(!items.length){
    el.innerHTML = `<div class="muted">Chưa có đơn mua.</div>`;
    return;
  }
  el.innerHTML = items.slice(0, 20).map(o => `
    <div class="item">
      <div>
        <b>${o.username}</b> mua <b>${o.serviceName}</b> ${badge(o.status)}
        <div class="muted">${Number(o.amount).toLocaleString()}đ • ${new Date(o.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

loadSummary();
</script>
</body>
</html>
