<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>ADMIN DASHBOARD</h1>
      </div>
      <div class="right">
        <button class="btn-secondary" id="btnRefresh">Refresh</button>
        <button class="btn-secondary" id="btnAdminLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Topup PENDING</h2>
        <div class="muted">Ki·ªÉm tra ng√¢n h√†ng xong b·∫•m duy·ªát (c·ªông ti·ªÅn).</div>
        <div id="pendingTopups" class="list"></div>
      
      <div class="card">
        <h2>H·ªó tr·ª£ & Li√™n h·ªá</h2>
        <div class="muted">G·ª≠i link/·∫£nh giao d·ªãch, m√£ n·∫°p ho·∫∑c th√¥ng tin ƒë∆°n ƒë·ªÉ x·ª≠ l√Ω nhanh.</div>
        <div class="hr"></div>
        <div class="support-box">
          <a class="btn-secondary" href="https://www.facebook.com/share/1ajgzqUGdh/" target="_blank" rel="noopener">M·ªü Facebook (Message)</a>
          <button class="btn-secondary" id="btnCopySupport" type="button">Copy m·∫´u tin nh·∫Øn</button>
        </div>
        <div class="note" id="supportNote" style="display:none"></div>
      </div>

</div>

      <div>
        <div class="card">
          <h2>Users</h2>
          <div class="muted">Set balance ho·∫∑c xo√° user.</div>
          <div id="users" class="list"></div>

          <div class="hr"></div>
          <h2>Thao t√°c nhanh</h2>
          <div class="row">
            <input id="opUser" placeholder="username" />
            <input id="opBal" type="number" placeholder="balance m·ªõi (VND)" />
            <button id="btnSetBal">Set Balance</button>
            <button id="btnDelUser" class="btn-danger">Xo√° User</button>
          </div>
          <div id="msg" class="note" style="display:none"></div>
        </div>

        <div class="card section-title">
          <h2>Orders (ƒë·ªïi tr·∫°ng th√°i)</h2>
          <div class="muted">PAID ‚Üí DOING ‚Üí DONE</div>
          <div id="orders" class="list"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const adminUser = localStorage.getItem("adminUser");
const adminPass = localStorage.getItem("adminPass");
if(!adminUser || !adminPass) location.href = "/admin.html";

function badge(status){ return `<span class="badge ${status}">${status}</span>`; }
function money(n){ return Number(n).toLocaleString("vi-VN"); }
function showMsg(t){ msg.style.display="block"; msg.innerText=t; }

btnAdminLogout.onclick = () => {
  localStorage.removeItem("adminUser");
  localStorage.removeItem("adminPass");
  location.href = "/admin.html";
};
btnRefresh.onclick = () => loadSummary();

btnCopySupport.onclick = async () => {
  const template = "M√¨nh c·∫ßn h·ªó tr·ª£ ƒë∆°n/n·∫°p ti·ªÅn\n- Username: ...\n- M√£ n·∫°p (NAP_...): ...\n- S·ªë ti·ªÅn: ...\n- ·∫¢nh giao d·ªãch: (ƒë√≠nh k√®m)\n- Ghi ch√∫ th√™m: ...";
  try{
    await navigator.clipboard.writeText(template);
    supportNote.style.display = "block";
    supportNote.innerText = "ƒê√£ copy m·∫´u tin nh·∫Øn. B·∫°n d√°n v√†o Messenger ƒë·ªÉ g·ª≠i.";
  }catch(e){
    supportNote.style.display = "block";
    supportNote.innerText = template;
  }
};

async function api(path, body){
  const r = await fetch(path, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ adminUser, adminPass, ...body })
  });
  return r.json();
}

async function loadSummary(){
  const r = await api("/api/admin/summary", {});
  if(!r.ok){ alert("Sai admin"); return location.href="/admin.html"; }

  renderTopups(r.topups || []);
  renderUsers(r.users || []);
  renderOrders(r.orders || []);
}

function renderTopups(items){
  const pend = items.filter(t => t.status === "PENDING");
  if(!pend.length){
    pendingTopups.innerHTML = `<div class="muted">Kh√¥ng c√≥ topup ch·ªù duy·ªát.</div>`;
    return;
  }
  pendingTopups.innerHTML = pend.map(t => `
    <div class="item">
      <div>
        <b>${t.username}</b> ‚Ä¢ <b>${money(t.amount)}ƒë</b> ${badge(t.status)}
        <div class="muted">N·ªôi dung: <span class="code">${t.code}</span></div>
        <div class="muted">${new Date(t.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button data-approve="${t.id}">Duy·ªát</button>
        <button class="btn-secondary" data-reject="${t.id}">T·ª´ ch·ªëi</button>
      </div>
    </div>
  `).join("");

  pendingTopups.querySelectorAll("button[data-approve]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute("data-approve");
      const d = await api("/api/admin/topups/approve", { topupId: id });
      if(!d.ok) return alert(d.msg || "Duy·ªát th·∫•t b·∫°i");
      await loadSummary();
    };
  });

  pendingTopups.querySelectorAll("button[data-reject]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute("data-reject");
      const d = await api("/api/admin/topups/reject", { topupId: id });
      if(!d.ok) return alert(d.msg || "T·ª´ ch·ªëi th·∫•t b·∫°i");
      await loadSummary();
    };
  });
}

function renderUsers(items){
  if(!items.length){
    users.innerHTML = `<div class="muted">Ch∆∞a c√≥ user.</div>`;
    return;
  }
  users.innerHTML = items.map(u => `
    <div class="item">
      <div>
        <b>${u.username}</b>
        <div class="muted">${u.gmail || ""}</div>
        <div class="muted">Created: ${u.createdAt || ""}</div>
      </div>
      <div class="pill">Balance: <b>${money(u.balance || 0)}ƒë</b></div>
    </div>
  `).join("");
}

function renderOrders(items){
  if(!items.length){
    orders.innerHTML = `<div class="muted">Ch∆∞a c√≥ order.</div>`;
    return;
  }

  orders.innerHTML = items.slice(0, 80).map(o => `
    <div class="item">
      <div style="flex:1">
        <div><b>${o.username}</b> ‚Ä¢ ${badge(o.status)}</div>
        <div><b>${o.serviceName}</b> <span class="muted">(${o.category || ""})</span></div>
        ${o.note ? `<div class="muted">üìù ${o.note}</div>` : ``}
        <div class="muted">${money(o.amount)}ƒë ‚Ä¢ ${new Date(o.createdAt).toLocaleString()}</div>
        ${o.updatedAt ? `<div class="muted">Update: ${new Date(o.updatedAt).toLocaleString()}</div>` : ``}
      </div>

      <div style="min-width:170px">
        <div class="muted" style="margin-bottom:6px">ƒê·ªïi status</div>
        <select data-id="${o.id}" class="status-select">
          <option value="PAID" ${o.status==="PAID"?"selected":""}>PAID</option>
          <option value="DOING" ${o.status==="DOING"?"selected":""}>DOING</option>
          <option value="DONE" ${o.status==="DONE"?"selected":""}>DONE</option>
        </select>
      </div>
    </div>
  `).join("");

  orders.querySelectorAll("select.status-select").forEach(sel => {
    sel.onchange = async () => {
      const orderId = sel.getAttribute("data-id");
      const status = sel.value;

      const d = await api("/api/admin/orders/set-status", { orderId, status });
      if(!d.ok) return alert(d.msg || "L·ªói ƒë·ªïi tr·∫°ng th√°i");
    };
  });
}

btnSetBal.onclick = async () => {
  const u = opUser.value.trim();
  const b = Number(opBal.value);
  if(!u) return showMsg("Thi·∫øu username");
  if(!Number.isFinite(b) || b < 0) return showMsg("Balance kh√¥ng h·ª£p l·ªá");

  const d = await api("/api/admin/set-balance", { username: u, balance: b });
  if(!d.ok) return showMsg(d.msg || "Set balance l·ªói");
  showMsg("ƒê√£ set balance");
  await loadSummary();
};

btnDelUser.onclick = async () => {
  const u = opUser.value.trim();
  if(!u) return showMsg("Thi·∫øu username");

  const ok = confirm("Xo√° user s·∫Ω xo√° c·∫£ l·ªãch s·ª≠ mua/n·∫°p. B·∫°n ch·∫Øc ch∆∞a?");
  if(!ok) return;

  const d = await api("/api/admin/delete-user", { username: u });
  if(!d.ok) return showMsg(d.msg || "Xo√° l·ªói");
  showMsg("ƒê√£ xo√° user. Removed=" + d.removed);
  await loadSummary();
};

loadSummary();
</script>
</body>
</html>
