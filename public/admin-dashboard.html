<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>ADMIN DASHBOARD</h1>
      </div>
      <div class="right">
        <button class="btn-secondary" id="btnRefresh">Refresh</button>
        <button class="btn-secondary" id="btnAdminLogout">Đăng xuất</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Topup PENDING</h2>
        <div class="muted">Kiểm tra ngân hàng xong bấm duyệt (cộng tiền).</div>
        <div id="pendingTopups" class="list"></div>
      </div>

      <div>
        <div class="card">
          <h2>Users</h2>
          <div class="muted">Có thể set balance hoặc xoá user.</div>
          <div id="users" class="list"></div>

          <div class="hr"></div>
          <h2>Thao tác nhanh</h2>
          <div class="row">
            <input id="opUser" placeholder="username" />
            <input id="opBal" type="number" placeholder="balance mới (VND)" />
            <button id="btnSetBal">Set Balance</button>
            <button id="btnDelUser" class="btn-danger">Xoá User</button>
          </div>
          <div id="msg" class="note" style="display:none"></div>
        </div>

        <div class="card section-title">
          <h2>Orders</h2>
          <div id="orders" class="list"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const adminUser = localStorage.getItem("adminUser");
const adminPass = localStorage.getItem("adminPass");
if(!adminUser || !adminPass) location.href = "/admin.html";

function badge(status){ return `<span class="badge ${status}">${status}</span>`; }
function money(n){ return Number(n).toLocaleString("vi-VN"); }
function showMsg(t){ msg.style.display="block"; msg.innerText=t; }

btnAdminLogout.onclick = () => {
  localStorage.removeItem("adminUser");
  localStorage.removeItem("adminPass");
  location.href = "/admin.html";
};
btnRefresh.onclick = () => loadSummary();

async function api(path, body){
  const r = await fetch(path, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ adminUser, adminPass, ...body })
  });
  return r.json();
}

async function loadSummary(){
  const r = await api("/api/admin/summary", {});
  if(!r.ok){ alert("Sai admin"); return location.href="/admin.html"; }

  renderTopups(r.topups || []);
  renderUsers(r.users || []);
  renderOrders(r.orders || []);
}

function renderTopups(items){
  const pend = items.filter(t => t.status === "PENDING");
  if(!pend.length){
    pendingTopups.innerHTML = `<div class="muted">Không có topup chờ duyệt.</div>`;
    return;
  }
  pendingTopups.innerHTML = pend.map(t => `
    <div class="item">
      <div>
        <b>${t.username}</b> • <b>${money(t.amount)}đ</b> ${badge(t.status)}
        <div class="muted">Nội dung: <span class="code">${t.code}</span></div>
        <div class="muted">${new Date(t.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button data-approve="${t.id}">Duyệt</button>
        <button class="btn-secondary" data-reject="${t.id}">Từ chối</button>
      </div>
    </div>
  `).join("");

  pendingTopups.querySelectorAll("button[data-approve]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute("data-approve");
      const d = await api("/api/admin/topups/approve", { topupId: id });
      if(!d.ok) return alert(d.msg || "Duyệt thất bại");
      await loadSummary();
    };
  });

  pendingTopups.querySelectorAll("button[data-reject]").forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute("data-reject");
      const d = await api("/api/admin/topups/reject", { topupId: id });
      if(!d.ok) return alert(d.msg || "Từ chối thất bại");
      await loadSummary();
    };
  });
}

function renderUsers(items){
  if(!items.length){
    users.innerHTML = `<div class="muted">Chưa có user.</div>`;
    return;
  }
  users.innerHTML = items.map(u => `
    <div class="item">
      <div>
        <b>${u.username}</b>
        <div class="muted">${u.gmail || ""}</div>
        <div class="muted">Created: ${u.createdAt || ""}</div>
      </div>
      <div class="pill">Balance: <b>${money(u.balance || 0)}đ</b></div>
    </div>
  `).join("");
}

function renderOrders(items){
  if(!items.length){
    orders.innerHTML = `<div class="muted">Chưa có order.</div>`;
    return;
  }
  orders.innerHTML = items.slice(0, 50).map(o => `
    <div class="item">
      <div>
        <b>${o.username}</b> • ${badge(o.status)}
        <div><b>${o.serviceName}</b> <span class="muted">(${o.category})</span></div>
        ${o.note ? `<div class="muted">${o.note}</div>` : ``}
        <div class="muted">${money(o.amount)}đ • ${new Date(o.createdAt).toLocaleString()}</div>
      </div>
    </div>
  `).join("");
}

btnSetBal.onclick = async () => {
  const u = opUser.value.trim();
  const b = Number(opBal.value);
  if(!u) return showMsg("Thiếu username");
  if(!Number.isFinite(b) || b < 0) return showMsg("Balance không hợp lệ");

  const d = await api("/api/admin/set-balance", { username: u, balance: b });
  if(!d.ok) return showMsg(d.msg || "Set balance lỗi");
  showMsg("Đã set balance");
  await loadSummary();
};

btnDelUser.onclick = async () => {
  const u = opUser.value.trim();
  if(!u) return showMsg("Thiếu username");

  const ok = confirm("Xoá user sẽ xoá cả lịch sử mua/nạp. Bạn chắc chưa?");
  if(!ok) return;

  const d = await api("/api/admin/delete-user", { username: u });
  if(!d.ok) return showMsg(d.msg || "Xoá lỗi");
  showMsg("Đã xoá user. Removed=" + d.removed);
  await loadSummary();
};

loadSummary();
</script>
</body>
</html>
