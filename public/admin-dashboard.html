<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/public/app.css" />
</head>
<body>
  <div class="topbar">
    <div>
      <div class="brand">Admin Dashboard</div>
      <div class="muted" id="who">...</div>
    </div>
    <div class="row">
      <button class="btn" id="reload">Tải lại</button>
      <button class="btn" id="logout">Đăng xuất</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2>Topup chờ duyệt</h2>
      <div id="topups" class="muted">...</div>
    </div>

    <div class="card">
      <h2>Đơn hàng</h2>
      <div id="orders" class="muted">...</div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
function money(n){ return (Number(n)||0).toLocaleString("vi-VN"); }

async function get(url){
  const r = await fetch(url);
  const j = await r.json().catch(()=>({ok:false}));
  if(!r.ok) throw new Error(j.message || "Request lỗi");
  return j;
}
async function post(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body || {})
  });
  const j = await r.json().catch(()=>({ok:false,message:"Lỗi JSON"}));
  if(!r.ok) throw new Error(j.message || "Request lỗi");
  return j;
}

async function loadMe(){
  try{
    const me = await get("/api/admin/me");
    $("who").textContent = `Xin chào: ${me.admin.username} • role: ${me.admin.role}`;
  }catch(e){
    location.href="/admin";
  }
}

async function loadTopups(){
  const r = await get("/api/admin/topups");
  const list = r.topups || [];
  const pend = list.filter(t => t.status === "Chờ duyệt");

  $("topups").innerHTML = pend.length ? pend.map(t=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>${t.method}</b>
        <span class="badge">${t.status}</span>
      </div>
      <div class="muted">User: <b>${t.username}</b></div>
      <div class="muted">Mã: <b>${t.code}</b> • Gửi: ${money(t.amount)}đ • Nhận: ${money(t.total)}đ</div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" onclick="approve('${t.id}')">Duyệt</button>
        <button class="btn" onclick="reject('${t.id}')">Từ chối</button>
      </div>
    </div>
  `).join("") : `<div class="muted">Không có topup chờ duyệt.</div>`;
}

async function loadOrders(){
  const r = await get("/api/admin/orders");
  const list = r.orders || [];
  $("orders").innerHTML = list.length ? list.map(o=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>${o.serviceName}</b>
        <span class="badge">${o.status}</span>
      </div>
      <div class="muted">User: <b>${o.username}</b> • Mã: <b>${o.id}</b> • ${money(o.price)}đ</div>
      <div class="muted">Ghi chú: ${o.note ? o.note.replaceAll("<","&lt;") : "(không có)"}</div>
      <div class="row" style="margin-top:10px">
        <select class="input" id="st_${o.id}" style="max-width:260px">
          <option ${o.status==="Đã tạo"?"selected":""}>Đã tạo</option>
          <option ${o.status==="Đang làm"?"selected":""}>Đang làm</option>
          <option ${o.status==="Hoàn thành"?"selected":""}>Hoàn thành</option>
          <option ${o.status==="Hủy"?"selected":""}>Hủy</option>
        </select>
        <button class="btn primary" onclick="setStatus('${o.id}')">Cập nhật</button>
      </div>
    </div>
  `).join("") : `<div class="muted">Chưa có đơn.</div>`;
}

window.approve = async (id)=>{
  try{
    await post(`/api/admin/topups/${id}/approve`, {});
    await loadTopups();
  }catch(e){ alert(e.message); }
};
window.reject = async (id)=>{
  const reason = prompt("Lý do từ chối?") || "";
  try{
    await post(`/api/admin/topups/${id}/reject`, { reason });
    await loadTopups();
  }catch(e){ alert(e.message); }
};
window.setStatus = async (id)=>{
  const st = document.getElementById("st_"+id).value;
  try{
    await post(`/api/admin/orders/${id}/status`, { status: st });
    await loadOrders();
  }catch(e){ alert(e.message); }
};

$("reload").onclick = async ()=>{
  await loadTopups();
  await loadOrders();
};
$("logout").onclick = async ()=>{
  await post("/api/admin/logout", {});
  location.href="/admin";
};

(async ()=>{
  await loadMe();
  await loadTopups();
  await loadOrders();
})();
</script>
</body>
  </html>
